<!--
/*
 * (c) 2016 Sunbridge Inc.
 *
 * リードに一括登録
 */
-->
<apex:page standardController="SmartViscaf__NameCard__c" recordSetVar="nameCardList" extensions="SB_NameCard_LeadBulkRegistController" title="{!$Label.SB_NCLD_Text_BusinessCard}: {!registerToLeadLabel}" tabStyle="SmartViscaf__NameCard__c" showHeader="true" sidebar="false">
  <apex:pageMessages id="pageMsgs" escape="false"/>

  <apex:form >
    <apex:actionFunction action="{!save}" name="save" reRender="pageMsgs,saveflage,nameCardTable, ncRecList" oncomplete="saveClick();"/>
    <apex:inputHidden value="{!saveOK}" id="saveflage"/>
    <apex:pageBlock title="{!registerToLeadLabel}">
      <apex:pageBlockButtons >
        <apex:commandButton onclick="startSave('{!$Component.savebtn}','{!$Component.cancelbtn}');" rerender="aa" value="{!$Label.SB_NCLD_Label_Save}" id="savebtn"/>
        <apex:commandButton id="cancelbtn" oncomplete="cancelClick();" value="{!$Label.SB_NCLD_Label_Cancel}" immediate="true"/>
      </apex:pageBlockButtons>
      <apex:pageBlockSection columns="2">

        <apex:selectRadio label="{!$Label.SB_NC_SearchCriteria}" value="{!searchType}">
          <apex:selectOptions value="{!searchTypeList}"/>
          <apex:actionSupport event="onclick" action="{!search}" rerender="pageMsgs, ncRecList"/>
        </apex:selectRadio>

        <apex:outputPanel >
          <apex:inputCheckbox value="{!leadOverwrite}"/>
          <apex:outputLabel value="{!overwriteLeadInfoLabel}"/>
        </apex:outputPanel>
      </apex:pageBlockSection>

      <apex:pageBlockTable id="ncRecList" value="{!nameCardRecordList}" var="ncRec">
        <apex:column rendered="{!hasError}">
          <apex:facet name="header"></apex:facet>
          <apex:image value="/img/msg_icons/error16.png" rendered="{!ncRec.hasError}"/>
        </apex:column>

        <apex:column >
          <apex:facet name="header">{!$Label.SB_NCLD_Label_Name}</apex:facet>
          <apex:outputPanel layout="none">
            <a href="/{!ncRec.nameCard.Id}" id="ncNm_{!ncRec.nameCard.Id}" onblur="LookupHoverDetail.getHover('ncNm_{!ncRec.nameCard.Id}').hide();" onfocus="LookupHoverDetail.getHover('ncNm_{!ncRec.nameCard.Id}', '/{!ncRec.nameCard.Id}/m?isAjaxRequest=1').show();" onmouseout="LookupHoverDetail.getHover('ncNm_{!ncRec.nameCard.Id}').hide();" onmouseover="LookupHoverDetail.getHover('ncNm_{!ncRec.nameCard.Id}', '/{!ncRec.nameCard.Id}/m?isAjaxRequest=1').show();">
              <apex:outputText value="{!ncRec.nameCard.Name}"/>
            </a>
          </apex:outputPanel>
        </apex:column>

        <apex:column >
          <apex:facet name="header">{!$Label.SB_NCLD_Label_Email}</apex:facet>
          <apex:outputText value="{!ncRec.nameCard.SmartViscaf__email__c}"/>
        </apex:column>

        <apex:column >
          <apex:facet name="header">{!$Label.SB_NCLD_Label_CompanyName}</apex:facet>
          <apex:outputText value="{!ncRec.nameCard.SmartViscaf__company_name__c}"/>
        </apex:column>

        <apex:column >
          <apex:facet name="header">{!$Label.SB_NCLD_Label_Prefectures}</apex:facet>
          <apex:outputText value="{!ncRec.nameCard.SmartViscaf__address_pref__c}"/>
        </apex:column>

        <apex:column >
          <apex:facet name="header">{!$Label.SB_NCLD_Label_Division}</apex:facet>
          <apex:outputText value="{!ncRec.nameCard.SmartViscaf__division__c}"/>
        </apex:column>

        <apex:column >
          <apex:facet name="header">{!$Label.SB_NCLD_Label_Position}</apex:facet>
          <apex:outputText value="{!ncRec.nameCard.SmartViscaf__title_name__c}"/>
        </apex:column>

        <apex:column >
          <apex:facet name="header">{!$Label.SB_NCLD_Text_Lead}</apex:facet>
          <apex:selectList value="{!ncRec.leadId}" size="1">
            <apex:selectOptions value="{!ncRec.leadSelOptList}"/>
          </apex:selectList>
        </apex:column>

        <apex:column >
          <apex:facet name="header">{!$Label.SB_NCLD_Label_ToDoRegistration}</apex:facet>
          <apex:inputCheckbox value="{!ncRec.registTodo}"/>
        </apex:column>
      </apex:pageBlockTable>

      <apex:pageBlockSection rendered="{!leadCreateable}"  title="{!specifiedWhenCreateNew}" columns="2">
        <apex:pageBlockSectionItem >
          <apex:outputLabel value="{!$Label.SB_NCLD_Label_Campaign}"/>
          <apex:inputField value="{!insertOption.campaign__c}"/>
        </apex:pageBlockSectionItem>

        <apex:pageBlockSectionItem rendered="{!showLeadRecType}">
            <apex:outputText value="{!$Label.SB_NCLD_Label_RecordTypeExplain}"/>
        </apex:pageBlockSectionItem>

        <apex:pageBlockSectionItem >
          <apex:outputLabel value="{!$Label.SB_NCLD_Label_Owner}"/>
          <apex:inputField value="{!ownerlead.OwnerId}" required="false"/>
        </apex:pageBlockSectionItem>

        <apex:pageBlockSectionItem rendered="{!showLeadRecType}">
            <apex:outputLabel  value="{!leadRecType}"/>
            <apex:selectList style="margin-left: 5pt;" id="lRecordType" value="{!leadRecordTypeId}" multiselect="false" size="1" disabled="{!Not(leadRecTypeEdit)}">
                <apex:selectOptions value="{!leadRecordTypeOptions}"/>
            </apex:selectList>
        </apex:pageBlockSectionItem>
      </apex:pageBlockSection>
    </apex:pageBlock>
    <script >

            var saveingValue = "{!$Label.SB_NCLD_Label_Saveing}";
            var saveid1 = "";
            var cancelid1 = "";
            var saveid2 = "";
            var cancelid2 = "";

            function saveChangeValue(strid){
                document.getElementById(strid).classList.add('btnDisabled');
                document.getElementById(strid).disabled="true";
                document.getElementById(strid).value=saveingValue;
            }

            function saveBackValue(strid,val){
                document.getElementById(strid).classList.remove('btnDisabled');
                document.getElementById(strid).disabled="";
                document.getElementById(strid).value=val;
            }

            var retUrl = '{!retUrl}';
           function cancelClick(){
                rePage();
            }

            function saveClick(){
                var saveok = document.getElementById('{!$Component.saveflage}').value;
                if(saveok == false || saveok == 'false'){
                    saveBackValue(saveid1,"{!$Label.SB_NCLD_Label_Save}");
                    saveBackValue(cancelid1,"{!$Label.SB_NCLD_Label_Cancel}");
                    saveBackValue(saveid2,"{!$Label.SB_NCLD_Label_Save}");
                    saveBackValue(cancelid2,"{!$Label.SB_NCLD_Label_Cancel}");
                    return;
                }
                rePage();
            }

            function rePage(){
                if( (typeof sforce != 'undefined') && (sforce != null) ) {
                    // S1とか
                    sforce.one.back();
                }
                else {
                  // クラシック
                  window.open(retUrl, "_top");
                }
            }


            function startSave(saveid,cancelid){
                saveid1 = isContains(saveid,'bottom');
                saveid2 = saveid;
                cancelid1 = cancelid;
                cancelid2 = isContains(cancelid,'bottom');
                saveChangeValue(saveid1);
                saveChangeValue(cancelid1);
                saveChangeValue(saveid2);
                saveChangeValue(cancelid2);
                save();
            }

            function isContains(str, substr) {
                var index = str.indexOf(substr);
                var changeid = '';
                if (index >0) {
                    changeid = str.substring(0,index) + str.substring(index + 7,str.length);
                }
                else {
                    var index1 = str.lastIndexOf(':');
                    changeid = str.substring(0,index1) + ':bottom' + str.substring(index1,str.length);
                }
                return changeid;
            }

          </script>
  </apex:form>
</apex:page>