version: 2.1
orbs:
  slack: circleci/slack@3.4.2

general:
# Uncomment the following to specify only a specific branch
#   branches:
#     only:
#       - dev # specific branch
#       - /dev-.*/ # or regexes

jobs:
  build:
    docker:
      - image: ncino/ci-sfdx
    # machine: true
    no_output_timeout: 30m
    working_directory: ~/ci_app
    environment:
      # from https://developer.salesforce.com/docs/atlas.en-us.sfdx_setup.meta/sfdx_setup/sfdx_setup_install_cli_standalone.htm
      # and https://developer.salesforce.com/media/salesforce-cli/manifest.json
      - DX_CLI_URL: https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
    steps:
      - checkout
      - run:
          name: File List
          command: |
            ls -l -R
            df -hT
      - run:
          name: Download CLI
          command: |
            mkdir sfdx
            wget -qO- $DX_CLI_URL | tar xJ -C sfdx --strip-components 1
      - run:
          name: Install CLI
          command: |
            ./sfdx/install
            sfdx
            mkdir tmp
      - run:
          name: Create hub key
          command: |
            echo 'make hub key'
            #- mkdir keys
            #- echo $HUB_SERVER_KEY_HEX | xxd -r -ps >> keys/hub.key
            openssl enc -nosalt -aes-256-cbc -d -in assets/server.key.enc -out assets/server.key -base64 -K $DECRYPTION_KEY -iv $DECRYPTION_IV
            #- openssl rsa -in keys/hub.key -check -noout



####################################################################################################
## JOB:     create-dev-scratch-org
## PURPOSE:
####################################################################################################
  create-dev-scratch-org:
    docker:
      - image: ncino/ci-sfdx
    # machine: true
    working_directory: ~/ci_app
    steps:
      - checkout
      - run:
          name: create-feature-scratch
          command: |
            echo 'create-feature-scratch'
            sfdx force:auth:jwt:grant --clientid $HUB_CONSUMER_KEY --jwtkeyfile assets/server.key --username $HUB_SFDC_USER --setdefaultdevhubusername

            sfdx force:org:create -f config/project-scratch-def.json -a ${CIRCLE_BRANCH} -s -d 30 --wait 5
            sfdx force:user:password:generate -u circleci  >> $BASH_ENV
      - run:
         name: 実行時の PATH 書き換えおよび環境変数定義
         command: |
          sfdx force:user:password:generate -u ${CIRCLE_WORKFLOW_ID} >> /tmp/ss.txt
      - run:
         name: 実行時の PATH 書き換えおよび環境変数定義
         command: |
          sfdx force:org:list >> /tmp/ss.txt
      - run: |
          echo 'export VERY_IMPORTANT=$(cat /tmp/ss.txt)' >> $BASH_ENV
          source $BASH_ENV

      - slack/notify:
          channel: '#general'
          color: '#42e2f4'
          include_job_number_field: false
          message: 'testbranch'
          webhook: '${SLACK_WEBHOOK}'


workflows:
  version: 2
  create_dev_scratch_org:
    jobs:
      - build
      - create-dev-scratch-org:
          requires: 
            - build
          context: org-sbdevhub
          filters:
            branches:
              ignore:
                - master
                - PreProduction
                - Production
  # build_and_test:
  #   jobs:
  #     - build:
  #         context: org-sbdevhub
  #         filters:
  #           branches:
  #             only:
  #               - master
  # create_beta_package:
  #   jobs:
  #     - create-beta-package:
  #         context: org-sbdevhub
  #         filters:  # ブランチのない、「v」から始まるタグに対してのみ実行します。
  #           tags:
  #              only:
  #                - /v.*/
  #           branches:
  #             ignore: /.*/