angular.module("SB_NameCard_Controllers",["SB_NameCard_SfdcServices","SB_NameCard_SfdcGeoServices"]).controller("NCMenuController",["$scope","$log","$location","sv_config","$localStorage","$sfdcService",function(t,a,r,e,n,o){t.viewType="List",t.targetType=t.targetType||"MineOnly",t.searchWord="",t.indexText="",t.config=e,t.namespace_x=namespace_x,t.clearList=!1,t.indexs=[{text:"アイウエオ",label:"ア"},{text:"カキクケコ",label:"カ"},{text:"サシスセソ",label:"サ"},{text:"タチツテト",label:"タ"},{text:"ナニヌネノ",label:"ナ"},{text:"ハヒフヘホ",label:"ハ"},{text:"マミムメモ",label:"マ"},{text:"ヤユヨ",label:"ヤ"},{text:"ラリルレロワヲン",label:"ラワ"},{text:"ABCDEFGH",label:"A - H"},{text:"IJKLMNOPQ",label:"I - Q"},{text:"RSTUVWXYZ",label:"R - Z"}],t.indexSearch=n.indexSearch||!1,t.toggleSeatchMode=function(){t.indexSearch=!t.indexSearch,n.indexSearch=t.indexSearch,a.info("indexSearch is : ",t.indexSearch)},t.toggled=function(e){a.info("Dropdown is now: ",e)};t.searchMine=function(e){t.searchWord="",t.viewType="List",t.targetType="MineOnly",r.path("/namecards/Target/"+t.targetType+"/Mode/new")},t.searchAll=function(e){t.searchWord="",t.viewType="List",t.targetType="All",r.path("/namecards/Target/"+t.targetType+"/Mode/new")},t.searchResent=function(e){t.searchWord="",t.viewType="List",t.targetType="Recent",r.path("/namecards/Target/"+t.targetType+"/Mode/new")},t.searchActual=function(e){t.searchWord="",t.viewType="List",t.targetType="Actual"},t.search=function(e){"MineOnly"!=t.targetType&&"All"!=t.targetType&&(t.targetType="All"),t.searchWord&&0!=t.searchWord.length?r.path("/namecards/Target/"+t.targetType+(t.searchWord&&""!=t.searchWord?"/Word/"+t.searchWord:"")):(t.clearList=!0,r.path("/namecards/Target/"+t.targetType+"/Mode/clear"))},t.searchIndex=function(e){"MineOnly"!=t.targetType&&"All"!=t.targetType&&(t.targetType="All"),e?(t.indexText=e,r.path("/namecards/Target/"+t.targetType+"/Index/"+e)):(t.indexText="",r.path("/namecards/Target/"+t.targetType+"/Mode/clear"))},t.tagdNamecards=function(){t.searchWord="",t.viewType="Tagd",t.targetType=null,r.path("/tagdNamecards/Mode/new")},t.findNearby=function(){t.searchWord="",t.viewType="NearBy",t.targetType=null,r.path("/findnearby")}}]).controller("NCListController",["$scope","$log","$routeParams","$location","$anchorScroll","$sessionStorage","$q","$document","$window","$timeout","$sfdcService","$translate","$filter",function(i,c,e,t,a,d,s,r,n,o,l,g,p){i.working=!0,i.err=null,i.errDialog=null,i.word=e.word?e.word:null,i.index=e.index?e.index:null,i.mode=i.word?"new":e.mode||"review";var u={};i.imageId=i.namespace_x+"image_id__c",i.$watch("[page, lastPage, order, desc, nameFilter, cardId, top]",function(){u.page=i.page,u.lastPage=i.lastPage,u.order=i.order,u.desc=i.desc,u.nameFilter=i.nameFilter,u.cardId=i.cardId,u.top=i.top,d[i.targetType]=u},!0);i.searchFilter=function(e){var t=new RegExp(i.nameFilter,"i");return!i.nameFilter||t.test(e.Name)||t.test(e[namespace_x+"company_name__c"])||t.test(e[namespace_x+"company_name_kana__c"])||t.test(e[namespace_x+"person_name_last_kana__c"])||t.test(e[namespace_x+"person_name_first_kana__c"])};function f(e,t,a,r,n){var o=s.defer();return i.working,i.index?i.orderBy(1,!1):i.orderBy(3,!0),l.searchNameCardsEx(null==r?e:"User",t,a,r,n,function(e){var t;null!=e.cards&&0<e.cards.length?(i.lastPage=!e.toBeCont,t=e.cards,void 0===i.cards&&(i.cards=[]),i.cards=i.cards.concat(t),u.cards=i.cards,d[i.targetType]=u):i.lastPage=!0,i.working=!1,i.$apply(),o.resolve()},function(e){c.error(e),i.err=e,i.page--,i.lastPage=!0,i.working=!1,i.$apply(),alert(p("translate")("M_SfdcError")),o.reject()}),o.promise}var m;i.isContinued=function(){return!i.lastPage},i.gotoTop=function(){1==iOSDevice?(i.cardId=i.cards[0].Id,t.hash(i.cards[0].Id),a()):n.scrollTo(0,0)},i.layoutDone=function(){"review"!=i.mode&&"more"!=i.mode||!i.cardId||o(function(){n.scrollTo(0,i.top)},0)},i.nextPage=function(){1!=i.working&&1!=i.lastPage&&(c.info("nextPage"),i.cardId=0<i.cards.length?i.cards[i.cards.length-1].Id:null,i.top=r.scrollTop(),i.page++,i.mode="more",f(i.targetType,i.word,i.index,i.userId,i.page).then(function(){i.working=!1}))},i.doDetail=function(e){c.info("doDetail :"+e),i.cardId=e,i.top=r.scrollTop(),c.log("scrollTop :"+i.top),1==i.config.sUseStandardNamecardViewUI?void 0!==n.sforce&&null!=n.sforce?n.sforce.one.navigateToURL("/"+e):n.open("/"+e,"_top"):t.path("/detail/"+e+"/ret/"+i.targetType)},i.orderBy=function(e,t){switch(e){case 1:if(i.order==namespace_x+"name_kana__c"&&i.desc==t)return;i.order=namespace_x+"name_kana__c",i.desc=t;break;case 2:if(i.order==namespace_x+"company_name_kana__c"&&i.desc==t)return;i.order=namespace_x+"company_name_kana__c",i.desc=t;break;case 3:if(i.order==namespace_x+"card_exchange_date__c"&&i.desc==t)return;i.order=namespace_x+"card_exchange_date__c",i.desc=t;break;default:i.order=namespace_x+"card_exchange_date__c",i.desc=!0}i.cards&&(i.cards=i.cards.sort(function(e,t){return e[i.order]==t[i.order]?e.Id>=t.Id?i.desc?-1:1:i.desc?1:-1:e[i.order]>t[i.order]?i.desc?-1:1:e[i.order]<t[i.order]?i.desc?1:-1:0}))},(m=s.defer(),void 0===i.config.userSetting?l.getSVConfigEx(function(e){!function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])}(i.config,e),"ja"!==i.config.sUserLanguage&&g.use(i.config.sUserLanguage),2===i.config.userSetting.svInitialListView||0===i.config.userSetting.svInitialListView&&2===i.config.userSetting.svLatestListView?(i.targetType="All",i.$parent.targetType="All"):(i.targetType="MineOnly",i.$parent.targetType="MineOnly"),c.info(i.config),i.$apply(),i.$broadcast("configFetched","stop"),m.resolve()},function(e){c.error(e),i.err=e,i.$apply(),alert(p("translate")("M_SfdcError")),m.reject()}):m.resolve(),m.promise).then(function(){if(!i.word&&!i.index&&"clear"!=i.mode&&i.config.sUseSessionStrage||(u=null,d[i.targetType]=u),d[i.targetType]?(u=d[i.targetType],i.$parent.searchWord=u.word||"",i.$parent.indexText=u.index||""):u={targetType:i.targetType,userId:i.userId,word:i.word,index:i.index,cards:[],page:null,lastPage:null,order:namespace_x+"card_exchange_date__c",desc:!0,nameFilter:"",cardId:"",top:null},i.userId=u.userId,i.word=u.word,i.index=u.index,i.cards=u.cards,i.page=u.page,i.lastPage=u.lastPage,i.order=u.order,i.desc=u.desc,i.nameFilter=u.nameFilter,i.cardId=u.cardId,i.top=u.top,1==i.working){void 0===i.cards||0==i.cards.length?(i.page=1,f(i.targetType,i.word,i.index,i.userId,i.page)):(i.working=!1,"review"==i.mode&&i.cardId);var e={svLatestListView:"All"===i.targetType?2:1};l.saveUserSetting(e,function(){},function(){})}})}]).controller("NCTagdListController",["$scope","$log","$routeParams","$location","$sessionStorage","$filter","$sfdcService",function(n,r,e,o,a,i,c){n.working=!0,n.isCollapsed=!0,n.oneAtATime=!0,n.err=null,n.errDialog=null,n.alerts=[],n.tags=[],n.curTag=null,n.curCardId=null,n.mode=e.mode||"review";var d={};n.$watch("[curTag, curCardId]",function(){d.curTag=n.curTag,d.curCardId=n.curCardId,a.tagdList=d},!0);n.doDetail=function(e,t,a){0!=a&&(r.info("doDetail :"+t),n.curTag=e,n.curCardId=t,1==n.config.sUseStandardNamecardViewUI?void 0!==$window.sforce&&null!=$window.sforce?$window.sforce.one.navigateToSObject(t):$window.open("/"+t,"_top"):o.path("/detail/"+t+"/ret/tagdNamecards"))},n.openCardsToLabel=function(e,t){r.info("apendCardsToTag :"+t.tagLabel),n.curTag=e,n.curCardId=null,o.path("/selNamecards/Label/"+t.tagLabel+"/Tag/"+t.tagIsTag)},n.removeCardInTagList=function(e,t){for(var a=0;a<n.tags.length;a++)if(n.tags[a].tagLabel==t){for(var r=0;r<n.tags[a].cards.length;r++)if(n.tags[a].cards[r].Id==e){n.tags[a].cards.splice(r,1);break}0==n.tags[a].cards.length&&n.tags.splice(a,1);break}},n.removeTag=function(t,a){r.info("remove "+t+a.tagLabel),n.working=!0,c.removeNameCardTag(t,a.tagLabel,a.tagIsTag,function(e){n.removeCardInTagList(t,a.tagLabel),n.working=!1,n.$apply()},function(e){r.error(e),n.err=e,n.working=!1,n.$apply(),alert(i("translate")("M_SfdcError"))})},n.isNewTag=function(e){for(var t=0;t<n.tags.length;t++)if(1==n.tags[t].tagIsTag&&1==angular.equals(n.tags[t].tagLabel,e)){var a=i("sprintfT")("M_Already",[e]);return n.alerts.push({type:"error",msg:a}),!1}return!0},n.addNewTag=function(){if(!(void 0===n.newTag||n.newTag.length<1)&&(n.alerts.length=0)!=n.isNewTag(n.newTag)){var e={tagLabel:n.newTag,tagIsTag:!0};n.tags.unshift(e),n.newTag="",n.isCollapsed=!0;var t=i("translate")("M_TagAddCard");n.alerts.push({type:"success",msg:t})}},n.closeAlert=function(e){n.alerts.splice(e,1)},(n.config.sUseSessionStrage||"new"!=n.mode)&&"reset"!=n.mode||(a.tagdList={}),d=a.tagdList||{},n.tags=d.tags||[],n.curTag=d.curTag||null,n.curCardId=d.curCardId||null,n.tags&&0!=n.tags.length?n.working=!1:(n.working=!0,c.getTagdNameCards(function(e){var t;n.tags=e,t=n.tags,d.tags=t,a.tagdList=d,n.working=!1,n.$apply()},function(e){r.error(e),n.err=e,n.working=!1,n.$apply(),alert(i("translate")("M_SfdcError"))}))}]).controller("NCSeleltCardsController",["$scope","$log","$routeParams","$location","$sfdcService","$filter",function(a,r,e,t,n,o){a.working=!0,a.err=null,a.errDialog=null,a.nameFilter=null,a.label=e.label,a.tagIsTag="true"==e.tag.toLowerCase(),a.index=-1,a.addCount=0,a.searchFilter=function(e){var t=new RegExp(a.nameFilter,"i");return!a.nameFilter||t.test(e.Name)||t.test(e.company_name__c)||t.test(e.person_name_last_kana__c)||t.test(e.person_name_first_kana__c)};var i,c;a.removeCard=function(e){for(var t=0;t<a.cards.length;t++)if(a.cards[t].Id==e.Id){a.cards.splice(t,1);break}},a.addCardToTag=function(t){n.bindNameCardsToLabel(t.Id,a.label,a.tagIsTag,function(e){a.removeCard(t),a.working=!1,a.addCount++,a.$apply()},function(e){r.error(e),a.err=e,a.working=!1,a.$apply(),alert(o("translate")("M_SfdcError"))})},a.return=function(){0<a.addCount?t.path("/tagdNamecards/Mode/reset"):t.path("/tagdNamecards")},i=e.label,c=e.tag,n.getNameCardsWithoutLabel(i,c,function(e){a.cards=e,a.working=!1,a.$apply()},function(e){r.error(e),a.err=e,a.working=!1,a.$apply(),alert(o("translate")("M_SfdcError"))})}]).controller("NCDetailController",["$scope","$log","$routeParams","$location","$filter","$window","$q","$svModal","$sessionStorage","$sfdcService",function(o,r,a,n,i,c,d,s,t,l){o.isCollapsed=!0,o.retPath=a.retPath||null,o.retId=a.retId||null,o.working=!0,o.err=null,o.errDialog=null,o.newTag="",o.card=null,o.tags=[],o.tagAlerts=[],o.doneOldCards=!1,o.doneMyActivities=!1,o.activities=[],o.eventRecTypes=[],o.taskRecTypes=[],o.users=[],o.nameFilter=null,o.doneOrgTree=!1,o.nodeList=[],o.selNode=a.cardId,o.selTags=[],o.oldCards=[],o.btnDisabled=!1,o.statuses=[{no:0,label:i("translate")("T_LatestCard")},{no:1,label:i("translate")("T_PreviousCard")},{no:2,label:i("translate")("T_BeforeChange")},{no:3,label:i("translate")("T_AfterChange")},{no:4,label:i("translate")("T_SameName")},{no:-1,label:i("translate")("T_Unknown")}],o.newsKey="",o.imgW=Math.min(c.innerWidth-30,300),o.labelRegist=i("sprintfT")("T_Regist",[o.config.accountLabel]),o.labelGotoA=i("sprintfT")("T_GoTo",[o.config.accountLabel]),o.labelGotoC=i("sprintfT")("T_GoTo",[o.config.contactLabel]),o.$on("configFetched",function(){o.labelRegist=i("sprintfT")("T_Regist",[o.config.accountLabel]),o.labelGotoA=i("sprintfT")("T_GoTo",[o.config.accountLabel]),o.labelGotoC=i("sprintfT")("T_GoTo",[o.config.contactLabel]),o.$apply()}),o.activeTab=0;o.toggleTagInput=function(){var e,t;o.isCollapsed=!o.isCollapsed,0==o.isCollapsed?(0<o.selTags.length&&o.selTags.splice(0),e=1,t=a.cardId,l.getTagsOrListnames(e,t,function(e){o.selTags=e,o.working=!1,o.$apply()},function(e){r.error(e),o.err=e,o.working=!1,o.$apply(),alert(i("translate")("M_SfdcError"))})):o.closeTagAlert(0)},o.isNewTag=function(e){return-1==o.tags.indexOf(o.newTag)||(o.tagAlerts.push({type:"danger",msg:i("translate")("M_InputTwice")}),!1)},o.closeTagAlert=function(e){o.tagAlerts.splice(e,1)},o.saveNewTag=function(){if(o.closeTagAlert(0),o.newTag&&""!=o.newTag){if(0==o.isNewTag(o.newTag))return;l.saveNameCardTag(o.card.id,o.newTag,function(e){o.tags=e.tags,o.working=!1,o.isCollapsed=!0,o.$apply(),t.tagdList={}},function(e){r.error(e),o.err=e,o.working=!1,o.$apply(),alert(i("translate")("M_SfdcError"))})}},o.openAccount=function(){o.btnDisabled=!o.btnDisabled,void 0!==c.sforce&&null!=c.sforce?c.sforce.one.navigateToURL("/"+o.card.accountId):c.open("/"+o.card.accountId,"_top")},o.openContact=function(){o.btnDisabled=!o.btnDisabled,void 0!==c.sforce&&null!=c.sforce?c.sforce.one.navigateToURL("/"+o.card.contactId):c.open("/"+o.card.contactId,"_top")},o.regist=function(){s.openLoading(),void 0!==c.sforce&&null!=c.sforce?c.sforce.one.navigateToURL("/apex/"+o.namespace_x+"SB_NameCard_SRegistIndex?id="+o.card.id+"&retUrl="+n.path()):c.open("/apex/"+o.namespace_x+"SB_NameCard_SRegistIndex?id="+o.card.id+"&retUrl="+n.path(),"_top")};function e(t){o.working=!0;var a=d.defer();return l.getSameCards(t,function(e){angular.forEach(e,function(e){e.id!=t&&o.oldCards.push(e)}),angular.forEach(e,function(e){-1==o.users.indexOf(e.owner)&&o.users.push(e.owner)}),o.working=!1,o.$apply(),a.resolve()},function(e){r.error(e),o.err=e,o.working=!1,o.$apply(),a.reject(),alert(i("translate")("M_SfdcError"))}),a.promise}o.tapImage=function(e,t,a,r){if(o.img={},o.img.imageId=e){var n=t.target.src;s.openImageModal(o,n)}};function g(e){var t=d.defer();return l.getRecordTypes(e,function(e){0!=e.length&&"Event"==e[0].objName?o.eventRecTypes=e:0!=e.length&&"Task"==e[0].objName&&(o.taskRecTypes=e),o.$apply(),t.resolve()},function(e){r.error(e),o.err=e,o.$apply(),alert(i("translate")("M_SfdcError")),t.reject()}),t.promise}o.openActivity=function(e){if(o.btnDisabled=!o.btnDisabled,1==o.config.sUseStandardActivityUI){var t=null!=e.task?e.task.Id:e.event.Id;void 0!==c.sforce&&null!=c.sforce?c.sforce.one.navigateToURL("/"+t):c.open("/"+t,"_top")}else null!=e.task?n.path("/openTask/"+o.card.id+"/Task/"+e.task.Id):n.path("/openEvent/"+o.card.id+"/Event/"+e.event.Id)},o.createTask=function(e,t){o.btnDisabled=!o.btnDisabled,e.preventDefault(),e.stopPropagation(),0==o.config.sUseStandardActivityUI?n.path("/openTask/"+o.card.id+"/Task/xxx/Mode/3/Rtid/"+(angular.isUndefined(t)?"XXX":t)):o.creteStdTask(t)},o.createEvent=function(e,t){o.btnDisabled=!o.btnDisabled,e.preventDefault(),e.stopPropagation(),0==o.config.sUseStandardActivityUI?n.path("/openEvent/"+o.card.id+"/Event/xxx/Mode/3/Rtid/"+(angular.isUndefined(t)?"XXX":t)):o.creteStdEvent(t)},o.creteStdEvent=function(e){if("undefined"!=typeof sforce&&null!=sforce){var t={WhatId:a.cardId};e?sforce.one.createRecord("Event",e,t):sforce.one.createRecord("Event",null,t)}else c.open("/00U/e?what_id="+o.card.id+"&who_id="+o.card.contactId+"&RecordType="+e,"_top")},o.creteStdTask=function(e){if("undefined"!=typeof sforce&&null!=sforce){var t={WhatId:a.cardId};sforce.one.createRecord("Task",e,t)}else c.open("/00T/e?what_id="+o.card.id+"&who_id="+o.card.contactId+"&RecordType="+e,"_top")};o.searchFilter=function(e){var t=new RegExp(o.nameFilter,"i");return!o.nameFilter||t.test(e.Name)||t.test(e.CompanyName)||t.test(e.Department)||t.test(e.Email)};var p,u;o.openSelectedNode=function(e){r.info("doDetail :"+o.selNode),18==e.length&&e!=o.card.id&&n.path("/detail/"+e+"/ret/detail/"+o.card.id)},o.openUser=function(e){n.path("/user/"+e+"/ret/"+o.card.id)},o.edit=function(){o.working=!0,1==o.config.sUseStandardNamecardEditUI?void 0!==c.sforce&&null!=c.sforce?c.sforce.one.editRecord(o.card.id):c.open("/"+o.card.id+"/e","_top"):n.path("/edit/"+o.card.id),o.working=!1},o.cancel=function(){"detail"==o.retPath&&null!=o.retId?n.path("/detail/"+o.retId):"NearBy"==o.viewType?n.path("/findnearby"):"Tagd"==o.viewType?n.path("/tagdNamecards"):n.path("/namecards")},o.openImageTab=function(){1!=o.doneOldCards&&(o.doneOldCards=!0,e(o.card.id).then(function(){o.doneOldCards=!0}))},o.openActivityTab=function(){var t;1!=o.doneMyActivities&&(t=d.defer(),o.working=!0,l.getMyActivities(o.card.id,function(e){o.activities=e,o.working=!1,o.doneMyActivities=!0,o.$apply(),t.resolve()},function(e){r.error(e),o.err=e,o.working=!1,o.$apply(),alert(i("translate")("M_SfdcError")),t.reject()}),t.promise).then(function(){return g("Event")}).then(function(){return g("Task")}).then(function(){o.doneMyActivities=!0})},o.openUsersTab=function(){1!=o.doneOldCards&&(o.doneOldCards=!0,e(o.card.id).then(function(){o.doneOldCards=!0}))},o.openOrgTreeTab=function(){1!=o.doneOrgTree&&function(){o.working=!0;var t=d.defer();return l.getCompnayTree(o.card.id,!1,function(e){o.working=!1,o.nodeList=e,o.$apply(),t.resolve()},function(e){o.working=!1,r.error(e),o.err=e,o.$apply(),alert(i("translate")("M_SfdcError")),t.reject()}),t.promise}().then(function(){o.doneOrgTree=!0})},p=a.cardId,u=d.defer(),l.getNameCardDetail(p,function(e){o.card=e.card,o.tags=e.tags,e.card.company_name?o.newsKey=e.card.company_name.replace(/株式会社|有限会社|合名会社|合資会社|合同会社|学校法人|[（(][株有名資同学][)）]|㈱|㈲|㈻/,""):o.newsKey=e.card.name,o.working=!1,o.activeTab=a.tab?parseInt(a.tab,10):0,o.$apply(),2===o.activeTab&&o.openActivityTab(),u.resolve()},function(e){r.error(e),o.err=e,o.working=!1,o.$apply(),alert(i("translate")("M_SfdcError")),u.reject()}),u.promise}]).controller("NCUserDetailController",["$scope","$log","$routeParams","$location","$sfdcService",function(t,a,e,r,n){t.userId=e.userId,t.retPath=e.retPath,t.working=!0,t.userProf={};var o;t.openUser=function(e){e&&r.path("/user/"+e+"/ret/"+t.retPath)},t.cancel=function(){t.working=!0,r.path("/detail/"+t.retPath),t.working=!1},o=t.userId,t.working=!0,n.getUserProfile(o,function(e){t.userProf=e,t.working=!1,t.$apply()},function(e){a.error(e),t.err=e,t.working=!1,t.$apply(),alert($filter("translate")("M_SfdcError"))})}]).controller("NCEditController",["$scope","$log","$routeParams","$location","$sfdcService",function(t,a,e,r,n){t.cardId=e.cardId,t.working=!1,t.err=null,t.errDialog=null,t.card={},t.cardlists=[],t.telPattern=/^[\d]+[\d\-]*[\d]+$/;var o,i,c;t.save=function(){t.working=!0,t.card.card_exchange_date=null;var e=new Array;e.push(t.card),n.saveNameCards(e,function(e){t.card=e[0],t.working=!1,t.$apply(function(){r.path("/detail/"+t.cardId)})},function(e){a.error(e),t.err=e,t.working=!1,t.$apply(),alert($filter("translate")("M_SfdcError"))})},t.delete=function(){t.working=!0,(new Array).push(t.card.Id),n.deleteNameCards(function(e){t.working=!1,t.$apply(function(){r.path("/namecards")})},function(e){a.error(e),t.err=e,t.working=!1,t.$apply(),alert($filter("translate")("M_SfdcError"))})},!(t.cancel=function(){t.working=!0,r.path("/detail/"+t.cardId),t.working=!1})===angular.isUndefined(e.cardId)&&(o=e.cardId,t.working=!0,n.getNameCard(o,function(e){t.card=e,t.working=!1,t.$apply()},function(e){a.error(e),t.err=e,t.working=!1,t.$apply(),alert($filter("translate")("M_SfdcError"))})),i=2,c=null,t.working=!0,n.getTagsOrListnames(i,c,function(e){t.cardlists=e,t.working=!1,t.$apply()},function(e){a.error(e),t.err=e,t.working=!1,t.$apply(),alert($filter("translate")("M_SfdcError"))})}]).controller("NCActivityController",["$scope","$log","$routeParams","$location","$filter","$sfdcService",function(r,n,e,o,i,c){r.loading=!1,r.err=null,r.errDialog=null,r.cardId=e.cardId;var t=new Date;r.activity={type:null!=e.taskId?1:null!=e.eventId?2:-1,subject:"",description:"",startDatetimeL:new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes()),endDatetimeL:new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours()+1,t.getMinutes()),allDay:!1,activityDateL:new Date(t.getFullYear(),t.getMonth(),t.getDate()),location:"",status:"",cardId:e.cardId,taskId:null!=e.taskId&&18==e.taskId.length?e.taskId:"",eventId:null!=e.eventId&&18==e.eventId.length?e.eventId:"",recordTypeId:angular.isUndefined(e.rtid)||18!=e.rtid.length?"":e.rtid},r.mode=1,r.mode=""!=r.activity.taskId||""!=r.activity.eventId?1:3,r.mode=angular.isUndefined(e.mode)?r.mode:e.mode,r.statusOptions=[],r.selStatus=null,r.minDateTime=new Date(t.getFullYear(),t.getMonth(),t.getDate()),r.maxDateTime=new Date,r.maxDateTime.setDate(r.minDateTime.getDate()+14),r.subjects={};r.getTaskStatusOptions=function(){c.getTaskStatusOptions(function(e){r.statusOptions=e,r.selStatus=r.statusOptions[0],r.loading=!1,r.$apply()},function(e){n.error(e),r.err=e,r.loading=!1,r.$apply()})},r.getActivitySubject=function(e){c.getActivitySubject(e,function(e){r.subjects=e,r.loading=!1,r.$apply()},function(e){n.error(e),r.err=e,r.loading=!1,r.$apply()})},r.getActivity=function(e){c.getActivity(e,function(e){var t,a;t=e,a=r.activity,angular.copy(t,a),t.eventId?(a.type=2,angular.isDefined(t.startDatetimeL)&&(a.startDatetimeL=new Date(t.startDatetimeL),a.activityDateL=new Date(a.startDatetimeL.getFullYear(),a.startDatetimeL.getMonth(),a.startDatetimeL.getDate())),angular.isDefined(t.endDatetimeL)&&(a.endDatetimeL=new Date(t.endDatetimeL))):(a.type=1,angular.isDefined(t.activityDateL)&&(a.activityDateL=new Date(t.activityDateL)),a.startDatetimeL=null,a.endDatetimeL=null),2==r.activity.type&&r.maxDateTime.setDate(r.activity.startDatetimeL.getDate()+14),r.activity.description&&(r.activity.description=r.activity.description.replace(/[\n\r]/g,"<br/>")),r.loading=!1,r.$apply()},function(e){n.error(e),r.err=e,r.loading=!1,r.$apply(),alert(i("translate")("M_SfdcError"))})},r.changeStart=function(){r.maxDateTime.setDate(r.activity.startDatetimeL.getDate()+14)},r.save=function(){1==r.activity.type&&(r.activity.status=r.selStatus.name);var e,t,a=(e=r.activity,t={},angular.copy(e,t),2===e.type?(e.allDay?(null!=e.startDatetimeL&&""!=e.startDatetimeL&&(t.activityDateL=Date.parse(e.startDatetimeL)),t.startDatetimeL=null,t.endDatetimeL=null):(t.activityDateL=null)!=e.startDatetimeL&&""!=e.startDatetimeL&&(t.startDatetimeL=Date.parse(e.startDatetimeL)),null!=e.endDatetimeL&&""!=e.endDatetimeL&&(t.endDatetimeL=Date.parse(e.endDatetimeL))):(null!=e.activityDateL&&""!=e.activityDateL&&(t.activityDateL=Date.parse(e.activityDateL)),t.startDatetimeL=null,t.endDatetimeL=null),t);c.saveActivities(a,function(e){!(r.loading=!1)===e.status?r.$apply(function(){o.path("/detail/"+r.cardId+"/tab/2")}):alert(e.message)},function(e){n.error(e),r.err=e,r.loading=!1,r.$apply(),alert(i("translate")("M_SfdcError"))})},r.remove=function(){r.working=!0;var e=1==r.activity.type?r.activity.taskId:r.activity.eventId;c.deleteSObject(e,function(e){!(r.loading=!1)===e.status?r.$apply(function(){o.path("/detail/"+r.cardId+"/tab/2")}):alert(e.message)},function(e){n.error(e),r.err=e,r.working=!1,r.$apply(),alert(i("translate")("M_SfdcError"))})},r.cancel=function(){o.path("/detail/"+r.cardId+"/tab/2")},r.openEdit=function(){1==r.activity.type?o.path("/openTask/"+r.cardId+"/Task/"+r.activity.taskId+"/Mode/2"):o.path("/openEvent/"+r.cardId+"/Event/"+r.activity.eventId+"/Mode/2")},1==r.activity.type&&r.getTaskStatusOptions(),""!=r.activity.taskId&&r.getActivity(r.activity.taskId),r.activity.eventId&&r.getActivity(r.activity.eventId),1!=r.mode&&r.getActivitySubject(r.activity.type)}]).controller("NCFindNearByController",["$scope","$log","$location","uiGmapGoogleMapApi","$sfdcGeoService",function(d,t,e,a,n){d.loading=!1,d.err=null,d.errDialog=null,d.showmap=!1,d.map={center:{latitude:35.679841,longitude:139.765092},zoom:13},d.currentPositon={},d.markers=[],d.onMarkerClicked=function(e){(markerToClose=e).showWindow=!e.showWindow,d.$apply()},d.getCardsNearByDefer=function(){n.getCurrentLocationDefer().then(function(e){d.map={center:{latitude:e.lat,longitude:e.lng},zoom:8},d.myMarkers=[{latitude:35.679841,longitude:139.765092},{latitude:35.779841,longitude:139.765092}],d.markers=d.myMarkers,d.showmap=!0},function(e){alert("Failed: "+e)},function(e){alert("Got notification: "+e)})},a.then(function(e){}),d.getCardsNearByEx=function(r){n.getFindNearbyEx(!0,"All",function(e,t,a){d.map={center:{latitude:e,longitude:t},zoom:13},d.currentPositon={latitude:e,longitude:t,icon:"https://maps.google.com/mapfiles/ms/micons/green.png"},d.$apply(),angular.forEach(a,function(e){r(e)}),d.fit=!0,d.loading=!1,d.$apply()},function(e){t.error(e),d.err=e,d.loading=!1,d.$apply()})},d.setupMarkerEx2=function(e){var t={latitude:e.lat,longitude:e.lng,options:{title:e.address},address:e.address,show:!1,companies:[],other:0,id:"2"};e.count>e.companies.length&&(t.other=e.count-e.companies.length);for(var a=0;a<e.companies.length;a++){var r=e.companies[a],n={companyName:r.companyName,cards:[],other:0};r.count>r.cards.length&&(n.other=r.count-r.cards.length);for(var o=0;o<e.companies[a].cards.length;o++){var i=e.companies[a].cards[o],c={name:i.Name,Id:i.Id,texts:[]};null!=i.division__c&&c.texts.push(i.division__c),null!=i.title_name__c&&c.texts.push(i.title_name__c),null!=i.tel1__c&&c.texts.push(i.tel1__c),n.cards.push(c)}t.companies.push(n)}t.onClick=function(){t.show=!t.show,d.$apply()},t.id="id"+d.markers.length,d.markers.push(t)},d.getCardsNearByEx(d.setupMarkerEx2)}]).controller("NCTestController",["$scope","$log","$uibModal","$window",function(e,t,a,r){}]);