"use strict";angular.module("SB_NameCard_WebControllers",["SB_NameCard_SfdcServices"]).controller("NCBaseController",["$scope","$location","sv_config","$sfdcService",function(n,e,t,o){n.config=t;o.getSVConfigEx(function(e){n.config=e,n.$apply()},function(e){$log.error(e),n.err=e,n.$apply()})}]).controller("NCTreeViewController",["$scope","$log","$routeParams","$location","$window","$q","$sfdcService",function(a,o,e,t,d,r,i){a.isCollapsed=!0,a.retPath=e.retPath||null,a.retId=e.retId||null,a.working=!1,a.err=null,a.errDialog=null,a.newTag="",a.card=null,a.tags=[],a.tagAlerts=[],a.doneOldCards=!1,a.doneMyActivities=!1,a.activities=[],a.eventRecTypes=[],a.taskRecTypes=[],a.users=[],a.nameFilter=null,a.doneOrgTree=!1,a.nodeList=[],a.selNode=e.cardId,a.selTag=void 0,a.selTags=[],a.oldCards=[],a.btnDisabled=!1,a.newsKey="",a.imgW=Math.min(d.innerWidth-30,300);a.toggleTagInput=function(){a.isCollapsed=!a.isCollapsed,0==a.isCollapsed?(0<a.selTags.length&&a.selTags.splice(0),function(e,n){i.getTagsOrListnames(e,n,function(e){a.selTags=e,a.working=!1,a.$apply()},function(e){o.error(e),a.err=e,a.working=!1,a.$apply()})}(1,e.cardId)):a.closeTagAlert(0)},a.closeTagAlert=function(e){a.tagAlerts.splice(e,1)},a.openAccount=function(){a.btnDisabled=!a.btnDisabled,void 0!==d.sforce&&null!=d.sforce?d.sforce.one.navigateToURL("/"+a.card.accountId):d.open("/"+a.card.accountId,"_top")},a.openContact=function(){a.btnDisabled=!a.btnDisabled,void 0!==d.sforce&&null!=d.sforce?d.sforce.one.navigateToURL("/"+a.card.contactId):d.open("/"+a.card.contactId,"_top")};a.getSameCards=function(){1!=a.doneOldCards&&(a.doneOldCards=!0,function(n){a.working=!0;var t=r.defer();return i.getSameCards(n,function(e){angular.forEach(e,function(e){e.id!=n&&a.oldCards.push(e)}),angular.forEach(e,function(e){-1==a.users.indexOf(e.owner)&&a.users.push(e.owner)}),a.working=!1,a.$apply(),t.resolve()},function(e){o.error(e),a.err=e,a.working=!1,a.$apply(),t.reject()}),t.promise}(a.card.id).then(function(){a.doneOldCards=!0}))};a.tapped=function(e,n,t,o){n.stopPropagation(),n.preventDefault(),n.gesture.preventDefault(),a.ios=iOSDevice&&!iOS8,a.deg=0,a.scaleFactor=1,a.offsetX="0px",a.offsetY="0px",a.front=t,a.imgIndex=-1,o&&(a.imgIndex=o),function(e,n){a.imageId=-1==n?e?a.card.image_id:a.card.bk_image_id:e?a.oldCards[n].image_id:a.oldCards[n].bk_image_id}(a.front,a.imgIndex),a.deg=0,a.ios||function(e){var n,t,o=d.innerWidth,r=d.innerHeight,i=new Image;i.src=e.target.src,i.width>i.height?(n=i.height>o?o/i.height:1,t=i.width>r?r/i.width:1,a.scaleFactor=Math.min(n,t),a.deg=-90,a.offsetX=50-Math.ceil(i.width*a.scaleFactor)+"px"):(n=i.width>o?o/i.width:1,t=i.height>r?r/i.height:1,a.scaleFactor=Math.min(n,t),a.deg=0,a.offsetX="0px",a.offsetY=Math.ceil(Math.min(i.height,d.innerHeight)*a.scaleFactor-Math.max(i.height,d.innerHeight))+"px"),a.offsetY="0px"}(n),a.imageId&&openImage()};a.getMyActivities=function(){1!=a.doneMyActivities&&function(){var n=r.defer();return a.working=!0,i.getMyActivities(a.card.id,function(e){a.activities=e,a.working=!1,a.$apply(),n.resolve()},function(e){o.error(e),a.err=e,a.working=!1,a.$apply(),n.reject()}),n.promise}().then(function(){a.doneMyActivities=!0})};a.openActivity=function(e){if(a.btnDisabled=!a.btnDisabled,1==a.config.sUseStandardActivityUI){var n=null!=e.task?e.task.Id:e.event.Id;void 0!==d.sforce&&null!=d.sforce?d.sforce.one.navigateToURL("/"+n):d.open("/"+n,"_top")}else null!=e.task?t.path("/openTask/"+a.card.id+"/Task/"+e.task.Id):t.path("/openEvent/"+a.card.id+"/Event/"+e.event.Id)},a.createTask=function(e,n){a.btnDisabled=!a.btnDisabled,e.preventDefault(),e.stopPropagation(),0==a.config.sUseStandardActivityUI?t.path("/openTask/"+a.card.id+"/Task/xxx/Mode/3/Rtid/"+(angular.isUndefined(n)?"XXX":n)):a.creteStdTask(n)},a.createEvent=function(e,n){a.btnDisabled=!a.btnDisabled,e.preventDefault(),e.stopPropagation(),0==a.config.sUseStandardActivityUI?t.path("/openEvent/"+a.card.id+"/Event/xxx/Mode/3/Rtid/"+(angular.isUndefined(n)?"XXX":n)):a.creteStdEvent(n)},a.creteStdEvent=function(e){"undefined"!=typeof sforce&&null!=sforce?e?sforce.one.createRecord("Event",e):sforce.one.createRecord("Event"):d.open("/00U/e?what_id="+a.card.id+"&who_id="+a.card.contactId+"&RecordType="+e,"_top")},a.creteStdTask=function(e){"undefined"!=typeof sforce&&null!=sforce?sforce.one.createRecord("Task",e):d.open("/00T/e?what_id="+a.card.id+"&who_id="+a.card.contactId+"&RecordType="+e,"_top")};a.searchFilter=function(e){var n=new RegExp(a.nameFilter,"i");return!a.nameFilter||n.test(e.Name)||n.test(e.CompanyName)||n.test(e.Department)||n.test(e.Email)};a.isTreeLoading=function(){return a.doneOrgTree},a.showCompnayTree=function(){1!=a.doneOrgTree&&function(){a.working=!0;var n=r.defer();return i.getCompnayTree(a.card.id,!1,function(e){a.working=!1,a.nodeList=e,a.$apply(),n.resolve()},function(e){a.working=!1,o.error(e),a.err=e,a.$apply(),n.reject()}),n.promise}().then(function(){a.doneOrgTree=!0})},a.openSelectedNode=function(e){o.info("doDetail :"+a.selNode),18==e.length&&e!=a.card.id&&("undefined"!=typeof sforce&&null!=sforce?sforce.one.navigateToURL("/"+e):window.open("/"+e,"_top"))},a.openUser=function(e){t.path("/user/"+e+"/ret/"+a.card.id)},a.edit=function(){a.working=!0,1==a.config.sUseStandardNamecardEditUI?void 0!==d.sforce&&null!=d.sforce?d.sforce.one.editRecord(a.card.id):d.open("/"+a.card.id+"/e","_top"):t.path("/edit/"+a.card.id),a.working=!1},a.cancel=function(){a.working=!0,d.open("/"+a.card.id,"_self"),a.working=!1};var n,c;n=e.cardId,c=r.defer(),i.getNameCardDetail(n,function(e){a.card=e.card,a.tags=e.tags,a.newsKey=e.card.company_name.replace(/株式会社|有限会社|合名会社|合資会社|合同会社|学校法人|[（(][株有名資同学][)）]|㈱|㈲|㈻/,""),a.working=!1,a.$apply(),c.resolve()},function(e){o.error(e),a.err=e,a.working=!1,a.$apply(),c.reject()}),c.promise}]);
