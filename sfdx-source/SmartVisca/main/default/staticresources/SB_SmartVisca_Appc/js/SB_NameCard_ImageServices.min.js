"use strict";angular.module("SB_NameCard_ImageServices",["SB_NameCard_SfdcServices"]).factory("$svCards",["$log","$q","$svcSettings","$svImageUtil","$sfdcService",function(u,f,o,g,p){var m=[],s=function(e,t,r){var n=o.get(),a=new FileReader;a.onload=function(){t.data=a.result,g.getResizedData(t.data,n.svcImageSize,function(e){t.blob=e.blob,t.data=e.data,t.height=e.height,t.width=e.width,t.yoko=t.width>t.height,r(t)})},a.readAsDataURL(e)};return{all:function(){return m},get:function(e){return 0<=e&&e<m.length?m[e]:null},remove:function(e,t){{if(angular.isUndefined(t)||0===t)return m.splice(m.indexOf(e),1),-1;if(1===t){if(null!=e.front)e.front=null;else if(null==e.back)return m.splice(m.indexOf(e),1),-1}else if(2===t)if(null!=e.back)e.back=null;else if(null==e.front)return m.splice(m.indexOf(e),1),-1}return 0},appendFile:function(a,i,e){var l=this.getLastInputs(),d=o.get();(function(r){var e,n=f.defer(),a=o.get(),i={file:null,blob:null,data:null,tBlob:null,tData:null,useTran:!0,name:r.name,type:r.type,height:"*",width:"*",yoko:!0,exif:null};a.svcImageTransform?(e=a.sDevelopment?{shade:a.svcShadeFilter,gabage1:a.svcNoiseFilter,gabage2:a.svcGabageFilter}:{shade:!1,gabage1:!1,gabage2:!1},new rit.default(e,{scale:.8},{size:7,compensation:7},a.svcInputImageSize,a.svcImageSize).run(r,function(e){var t={};t.width=e.width,t.height=e.height,t.data=e.toDataURL("image/jpeg"),t.blob=g.dataURLtoBlob(t.data),a.svcConfirmTransform?(i.file=r,i.tData=t.data,i.tBlob=t.blob):(i.data=t.data,i.blob=t.blob),i.height=t.height,i.width=t.width,i.yoko=i.width>i.height,n.resolve(i)},function(e){i.useTran=!1,i.error=e,s(r,i,function(e){n.resolve(e)})})):(i.useTran=!1,s(r,i,function(e){n.resolve(e)}));return n.promise})(a).then(function(e){var t,o,s,c,r,n=null;0<m.length&&d.svcDoubleSide&&null==m[m.length-1].back?(n=m[m.length-1]).back=e:(n={index:m.length,front:e,back:null,memo:d.svcRepeatMemo&&l.memo?l.memo:"",date:d.svcRepeatExchangeDate?l.date:new Date,card_id:"",result:0},m.push(n)),e.error&&d.svcReportImgTranFailure?(t=a,o=d,s=e.error,c=f.defer(),(r=new FileReader).onload=function(){g.getResizedData(r.result,o.svcInputImageSize,function(e){var t=e.data.split("base64,")[1],r=s.data;r.lines=s.data.lines.length;var n=JSON.stringify({data:r,settings:o}),a=s.stack,i=JSON.stringify({userAgent:navigator.userAgent,ipAddress:configFromEnv.clientIPAddress,blobB64:t,contentType:"image/jpeg",errorInfo:n,stackTrace:a});p.sendVerificationInfo(i,function(e){c.resolve()},function(e){u.error(e),c.reject()})})},r.readAsDataURL(t),c.promise).then(function(){i(n)},function(){i(n)}):i(n)},function(){e(null)})},createNormal:function(e,t,r,n){var a=t?e.back.file:e.front.file,i=t?e.back:e.front;s(a,i,function(e){r()})},updateCard:function(e){if(null==e)return;m.splice(m.indexOf(e),1,e)},getLastInputs:function(){return 0!=m.length?m[m.length-1]:{memo:"",date:new Date}},clear:function(){m.splice(0,m.length)},size:function(){return m.length}}}]).factory("$svLocalstorage",["$window",function(r){return{set:function(e,t){r.localStorage["sv-"+e]=t},get:function(e,t){return r.localStorage["sv-"+e]||t},setObject:function(e,t){r.localStorage["sv-"+e]=JSON.stringify(t)},getObject:function(e){return JSON.parse(r.localStorage["sv-"+e]||"{}")}}}]).factory("$svcSettings",["$window","$sfdcService",function(t,r){return{set:function(e){t.localStorage["svc-settings"]=JSON.stringify(e),r.saveUserSetting(e,function(){},function(){})},get:function(){var e=JSON.parse(t.localStorage["svc-settings"]||'{ "svcDoubleSide": true,  "svcImageTransform": true, "svcConfirmTransform": true, "svcShadeFilter": false, "svcNoiseFilter": false, "svcGabageFilter": false, "svcInputImageSize": 1200, "svcViewMode": "list",  "svcImageSize": 600,  "svcRepeatExchangeDate": true,  "svcRepeatMemo": true,  "svcKeepListName": true,  "svcPreviousListName": "",  "svcFreehandMemo": false,  "svcFrontOnly": false,  "svcGeoLocation": false, "svcReportImgTranFailure": false }');return angular.isUndefined(e.svcImageTransform)&&(e.svcImageTransform=!1,e.svcConfirmTransform=!0),e.svcImageSize=600,angular.isUndefined(e.svcShadeFilter)&&(e.svcShadeFilter=!1,e.svcNoiseFilter=!1,e.svcGabageFilter=!1,e.svcInputImageSize=1200),e}}}]).factory("$svImageUtil",["$q",function(e){return{createBlobFromDataUrl:function(e,t,r){var n,a,i,o;t=t||"image/jpeg";a=atob(e.split("base64,")[1]),o=a.length,n=new Uint8Array(o),i=0;for(;i<o;)n[i]=a.charCodeAt(i),i++;return new Blob([n],{type:t})},getResizedData:function(_,e,y,t){var I={blob:null,data:null,width:0,height:0},D=e,U=e,O=new Image;O.onload=function(){var e,t=O.naturalWidth,r=O.naturalHeight,n=t,a=r;if(_.split(",")[0].match("jpeg")&&(e=k(_)),4<(e=e||1)){var i=D;D=U,U=i}if(D<n||U<a){var o=n/D;o<=a/U&&(o=a/U),n=Math.floor(O.width/o),a=Math.floor(O.height/o)}var s=$("<canvas>"),c=s[0].getContext("2d");c.save(),F(s,n,a,e),C(O)&&(t/=2,r/=2);var l=1024,d=$("<canvas>");d[0].width=d[0].height=l;for(var u=d[0].getContext("2d"),f=B(O,t,r),g=Math.ceil(l*n/t),p=Math.ceil(l*a/r/f),m=0,v=0;m<r;){for(var h=0,S=0;h<t;)u.clearRect(0,0,l,l),u.drawImage(O,-h,-m),c.drawImage(d[0],0,0,l,l,S,v,g,p),h+=l,S+=g;m+=l,v+=p}c.restore(),d=u=null;var w=c.canvas.toDataURL("image/jpeg",.9),b=M(w);I.data=w,I.blob=b,I.width=n,I.height=a,y(I)},O.src=_;var k=function(e){var t=r(e);return EXIF.readFromBinaryFile(t).Orientation},C=function(e){var t=e.naturalWidth;if(1048576<t*e.naturalHeight){var r=$("<canvas>");r[0].width=r[0].height=1;var n=r[0].getContext("2d");return n.drawImage(e,1-t,0),0===n.getImageData(0,0,1,1).data[3]}return!1},B=function(e,t,r){var n=$("<canvas>");n[0].width=1,n[0].height=r;var a=n[0].getContext("2d");a.drawImage(e,0,0);for(var i=a.getImageData(0,0,1,r).data,o=0,s=r,c=r;o<c;){0===i[4*(c-1)+3]?s=c:o=c,c=s+o>>1}var l=c/r;return 0==l?1:l},F=function(e,t,r,n){4<n?(e[0].width=r,e[0].height=t):(e[0].width=t,e[0].height=r);var a=e[0].getContext("2d");switch(n){case 2:a.translate(t,0),a.scale(-1,1);break;case 3:a.translate(t,r),a.rotate(Math.PI);break;case 4:a.translate(0,r),a.scale(1,-1);break;case 5:a.rotate(.5*Math.PI),a.scale(1,-1);break;case 6:a.rotate(.5*Math.PI),a.translate(0,-r);break;case 7:a.rotate(.5*Math.PI),a.translate(t,-r),a.scale(-1,1);break;case 8:a.rotate(-.5*Math.PI),a.translate(-t,0)}}},dataURLtoBlob:M,base64ToArrayBuffer:r};function M(e){var t=e.split(",")[0].split(":")[1].split(";")[0],r=function(e){for(var t=atob(e.split(",")[1]),r=new ArrayBuffer(t.length),n=new Uint8Array(r),a=0;a<t.length;a++)n[a]=t.charCodeAt(a);return r}(e),n=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;return n?((n=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder)).append(r),n.getBlob(t)):n=new Blob([r],{type:t})}function r(e){e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var t=atob(e),r=t.length,n=new Uint8Array(r),a=0;a<r;a++)n[a]=t.charCodeAt(a);return n.buffer}}]).factory("$svModal",["$sfdcService","$filter","$uibModal","$log","$q",function(a,i,o,s,c){return{openLoading:function(){return e=o.open({animation:!1,template:"&nbsp;",windowTemplateUrl:"loadingWindow.html",size:"sm",backdrop:!0})},closeLoading:function(){e&&(e.close(),e=null)},openSelectOwner:function(t,e){var r=c.defer();t.working=!1;var n=o.open({scope:t,animation:!0,backdrop:"static",templateUrl:e,controller:"SelectOwnerCtrl",size:"lg"});t.departmentUsers||(t.working=!0,function(t){var r=c.defer();return a.getDepartmentUsers(null,null,function(e){t.departmentUsers=e,t.working=!1,t.$apply(),r.resolve()},function(e){s.error(e),t.sfdcErr=e,t.working=!1,t.$apply(),alert(i("translate")("M_SfdcError")),r.reject()}),r.promise}(t).then(function(){t.selectedUser&&!t.selectedUser.dept&&(t.enableSearch=!t.departmentUsers.underLimit,t.selectedUser.dept=t.departmentUsers.departments[0]),t.dlgItems={dept:t.selectedUser.dept,user:{id:t.selectedUser.user.id},userFilter:""}},function(){n.dismiss()}));return n.result.then(function(e){s.info("SelectOwner OK at: "+new Date),e.user?t.selectedUser={dept:e.dept,user:{label:e.user.label,id:e.user.id}}:t.selectedUser={dept:e.dept,user:null},n=null,r.resolve("OK")},function(){s.info("SelectOwner dismissed at: "+new Date),n=null,r.reject("Cancel")}),r.promise},openConfirm:function(e,t){var r=c.defer(),n=o.open({scope:e,animation:!0,backdrop:"static",templateUrl:t,size:"sm"});return n.result.then(function(){s.info("Confirm OK at: "+new Date),n=null,r.resolve("OK")},function(){s.info("Confirm dismissed at: "+new Date),n=null,r.reject("Cancel")}),r.promise},openProgress:function(e){var t=c.defer(),r=o.open({scope:e,animation:!0,backdrop:"static",templateUrl:"uploading.html",size:"lg"});return r.result.then(function(){s.info("Upload completed at: "+new Date),r=null,t.resolve("success")}),t.promise},openWarning:function(e){var t=c.defer(),r=o.open({animation:!0,backdrop:"static",template:'<div class="modal-body"><p><i class="fa fa-exclamation-circle fa-lg" style="color:#2aabd2;"></i>&nbsp;'+e+'</p></div><div class="modal-footer" style="background-color :#f8f8ff"><button class="pull-right btn btn-info col-xs-4" ng-click="$close()">OK</button></div>',size:"sm"});return r.result.then(function(){r=null,t.resolve("success")},function(){r=null,t.reject("falt")}),t.promise},openImage:function(e){o.open({animation:!0,backdrop:!0,scope:e,templateUrl:"imageWindow.html",controller:"OpenImageCtrl",windowClass:"modalFrame modalBody",size:"lg"})}};var e}]).controller("SelectOwnerCtrl",["$scope","$sfdcService","$filter","$uibModalInstance","$log","$q",function(r,e,n,t,a,i){r.searchFilter=function(e){var t=new RegExp(r.dlgItems.userFilter,"i");return!r.dlgItems.userFilter||t.test(e.name)||t.test(e.email)||t.test(e.userName)||t.test(e.department)};r.searchUser=function(){var t;t=i.defer(),r.working=!0,e.getDepartmentUsers(r.dlgItems.dept,r.dlgItems.userFilter,function(e){e.underLimit||alert(n("translate")("T_TooManyResults")),r.departmentUsers.dept2Users=e.dept2Users,r.working=!1,r.$apply(),t.resolve()},function(e){a.error(e),r.sfdcErr=e,r.working=!1,r.$apply(),alert(n("translate")("M_SfdcError")),t.reject()}),t.promise},r.ok=function(){t.close(r.dlgItems)},r.cancel=function(){t.dismiss("cancel")}}]).controller("OpenImageCtrl",["$scope","$uibModalInstance","$log",function(t,r,n){function e(){t.scaleFactor=1,t.posX=0,t.posY=0,a=t.front?t.card.front.width:t.card.back.width,i=t.front?t.card.front.height:t.card.back.height,n.info("imgW:"+a+" imgH"+i)}var a,i;t.paned=function(e){n.info("event.deltaX: "+e.deltaX+" event.deltaY: "+e.deltaY),n.info("event.element.parent().width(): "+e.element.parent().width()+" event.element.parent().height(): "+e.element.parent().height()),n.info("imgW:"+a+" imgH"+i),t.scaleFactor*a>e.element.parent().width()&&(t.posX=Math.max(t.posX+e.deltaX,e.element.parent().width()-t.scaleFactor*a),t.posX=Math.min(t.posX,0)),t.scaleFactor*i>e.element.parent().height()-42&&(t.posY=Math.max(t.posY+e.deltaY,e.element.parent().height()-42-t.scaleFactor*i),t.posY=Math.min(t.posY,0))},t.pinched=function(e){n.info(e.type),1<e.scale||(t.scaleFactor=e.scale)},t.tapped=function(e){n.info(e),r.dismiss()},t.reverse=function(){t.front&&null!=t.card.back&&(t.front=!t.front,e())},e()}]).factory("$svHistory",["$window",function(i){function o(e){if(angular.isDefined(e.dt))return new Date(e.dt);var t=e.date.split(" ");return 0<t.length?new Date(t[0]):new Date}return{getTemplate:function(e){var t=new Date;return{date:t.getFullYear()+"/"+("0"+(t.getMonth()+1)).slice(-2)+"/"+("0"+t.getDate()).slice(-2)+" "+["日","月","火","水","木","金","土"][t.getDay()],time:("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2),location:{lat:null,lng:null},listname:e.settings.listName,freehandmemo:e.settings.svcFreehandMemo,svcFrontOnly:e.settings.svcFrontOnly,cards:e.cards.length,images:e.imageCount,dt:t.toString()}},get:function(){return i.localStorage["svc-history"]?JSON.parse(i.localStorage["svc-history"]):[]},append:function(e){var t=i.localStorage["svc-history"]?JSON.parse(i.localStorage["svc-history"]):[];99<t.length&&t.splice(0,1);t.push(e),i.localStorage["svc-history"]=JSON.stringify(t)},clear:function(){window.localStorage.removeItem("svc-history")},getDailyBlocked:function(){var e=i.localStorage["svc-history"]?JSON.parse(i.localStorage["svc-history"]):[];if(0===e.length)return[];e.sort(function(e,t){return t.date===e.date?t.time===e.time?0:t.time>e.time?1:-1:t.date>e.date?1:-1});for(var t=[],r="",n=0;n<e.length;n++)if(r!==e[n].date){var a={date:e[n].date,dt:o(e[n]).toDateString(),actions:[e[n]]};t.push(a),r=e[n].date}else t[t.length-1].actions.push(e[n]);return t}}}]).factory("$svGps",["$log","$q",function(t,e){return{getCurrentLocation:function(r,n){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var t={lat:null,lng:null};t.lat=e.coords.latitude,t.lng=e.coords.longitude,r(t)},function(e){var t=[{error_code:e.code,description:e.message}];n(t)}):n([{error_code:"-1",description:"位置情報取得エラー"}])},getCurrentLocationPromise:function(){var r=e.defer();navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t={};t.latitude=e.coords.latitude,t.longitude=e.coords.longitude,r.resolve(t)},function(e){t.error("ERROR("+e.code+"): "+e.message),r.reject()});return r.promise}}}]).factory("$svServer",["$log","$q","$http","$filter",function(d,e,u,i){function f(e){if(angular.isUndefined(e))return[{error_code:"-1",description:i("translate")("T_NetError")}];var t=[];return $(e.getElementsByTagName("error")).each(function(){var e={};e.error_code=$(this).find("error_code").text(),e.description=$(this).find("description").text(),t.push(e)}),t}return{versionCheck:function(e,i,o){var t={service_id:e.sSmartViscaServeServiceID,version:"2.4.2"},r=e.sSmartViscaServer+"/"+(e.devMode?"rego_dev/":"rego_paid/")+"scan/SUNBRIDGE/versioncheck/";u.post(r,$.param(t),{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e,t,r,n,a){d.info(e),d.info(t),i()}).error(function(e,t,r,n,a){d.error(e),d.error(t),o()})},loginUserAuth:function(e,i,o){var t={service_id:e.sSmartViscaServeServiceID,password:"sb201407",service_client_id:"",login_id:"svdev06@sb.co.jp"},r=e.sSmartViscaServer+"/"+(e.devMode?"dev/":"paid/")+"loginuserauth/";u.post(r,$.param(t),{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e,t,r,n,a){d.info(e),d.info(t),i()}).error(function(e,t,r,n,a){d.error(e),d.error(t),o()})},userAuth:function(e,t,r){},sendScanLotData:function(e,t,c,l){var r={service_id:t.sSmartViscaServeServiceID,service_client_id:(t.devMode?"DEV_":"PAID_")+t.sOrgId,service_division_id:"0_"+t.sSessionId,service_user_id:e.ownerId?e.ownerId:t.sUserId,list_name:e.list_name?e.list_name.substr(0,100):null,scanner_name:t.sScannerName,card_count:e.card_count,open_flag:0,freehandmemo_flag:e.freehandmemo_flag,digitalize_mode:9,past_card_flag:0,env_machine_name:t.sSfdcEndPoint,env_user_name:t.userName,env_local_ip_address:t.sClinetIPAddress,env_scan_user_id:t.sUserId,scan_app_option:"app=SmartViscaCamera"+(e.svcFrontOnly?",English":"")};angular.isDefined(t.sSmartViscaServerOptions)&&angular.isObject(t.sSmartViscaServerOptions)&&angular.forEach(t.sSmartViscaServerOptions,function(e,t){r[t]=e});var n=t.sSmartViscaServer+"/"+(t.devMode?"rego_dev/":"rego_paid/")+"scan/SUNBRIDGE/sendscanlotdata/";u.post(n,$.param(r),{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformResponse:function(e,t,r){return $.parseXML(e)}}).success(function(e,t,r,n,a){var i=$(e.getElementsByTagName("send")),o=$(e.getElementsByTagName("session"));if(!1===angular.isUndefined(i)&&!1===angular.isUndefined(o)&&0<i.length&&0<o.length)d.info(o.attr("value")),d.info(i.attr("id")),c({regoSessionId:o.attr("value"),send_id:i.attr("id")});else{var s=f(e);l(s)}}).error(function(e,t,r,n,a){l([{error_code:t,description:i("translate")("T_NetError")+a}])})},sendCardData:function(e,t,r,s,c){var n=new FormData;n.append("service_id",r.sSmartViscaServeServiceID),n.append("send_id",e.send_id),n.append("memo",t.memo?t.memo.substr(0,100):null),n.append("card_exchange_date",t.date?i("date")(t.date,"yyyy/MM/dd"):""),angular.isDefined(r.sSmartViscaServerOptions)&&angular.isObject(r.sSmartViscaServerOptions)&&angular.forEach(r.sSmartViscaServerOptions,function(e,t){n.append(t,e)});n.append("card_file1",t.front.blob,t.front.name),d.info(t.front.name);var a=r.sSmartViscaServer+"/"+(r.devMode?"rego_dev/":"rego_paid/")+"scan/SUNBRIDGE/sendcarddata/";u.post(a,n,{withCredentials:!0,headers:{"Content-Type":void 0,Cookie:"REGOSESSID="+e.regoSessionId},transformRequest:angular.identity,transformResponse:function(e,t,r){return $.parseXML(e)}}).success(function(e,t,r,n,a){var i=$(e.getElementsByTagName("card"));if(!1===angular.isUndefined(i)&&0<i.length)d.info(i.attr("id")),s({card_id:i.attr("id")});else{var o=f(e);c(o)}}).error(function(e,t,r,n,a){c([{error_code:t,description:i("translate")("T_NetError")+a}])})},sendBackCardData:function(e,t,r,s,c){var n=new FormData;n.append("send_id",e.send_id),n.append("card_id",t.card_id),r.sSSmartViscaServerProxyFlag&&n.append("proxy_flag",1);angular.isDefined(r.sSmartViscaServerOptions)&&angular.isObject(r.sSmartViscaServerOptions)&&angular.forEach(r.sSmartViscaServerOptions,function(e,t){n.append(t,e)});t.back&&n.append("card_file2",t.back.blob,t.back.name);d.info(t.back?t.back.name:"none");var a=r.sSmartViscaServer+"/"+(r.devMode?"rego_dev/":"rego_paid/")+"scan/SUNBRIDGE/sendbackcarddata/";u.post(a,n,{withCredentials:!0,headers:{"Content-Type":void 0,Cookie:"REGOSESSID="+e.regoSessionId},transformRequest:angular.identity,transformResponse:function(e,t,r){return $.parseXML(e)}}).success(function(e,t,r,n,a){var i=$(e.getElementsByTagName("card"));if(!1===angular.isUndefined(i)&&0<i.length)d.info(i.attr("id")),s({card_id:i.attr("id")});else{var o=f(e);c(o)}}).error(function(e,t,r,n,a){c([{error_code:t,description:i("translate")("T_NetError")+a}])})},sendEnd:function(e,t,c,l){var r={card_count:e.card_count,send_id:e.send_id};angular.isDefined(t.sSmartViscaServerOptions)&&angular.isObject(t.sSmartViscaServerOptions)&&angular.forEach(t.sSmartViscaServerOptions,function(e,t){r[t]=e});var n=t.sSmartViscaServer+"/"+(t.devMode?"rego_dev/":"rego_paid/")+"scan/SUNBRIDGE/sendend/";u.post(n,$.param(r),{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformResponse:function(e,t,r){return $.parseXML(e)}}).success(function(e,t,r,n,a){var i=$(e.getElementsByTagName("send")),o=$(e.getElementsByTagName("finish_code"));if(!1===angular.isUndefined(i)&&!1===angular.isUndefined(o)&&0<i.length&&null!=o)d.info(o.text()),d.info(i.attr("id")),d.info(i.attr("count")),c({finish_code:o.text(),send_id:i.attr("id"),send_count:i.attr("count")});else{var s=f(e);l(s)}}).error(function(e,t,r,n,a){var i=$(e.getElementsByTagName("error_code")),o=$(e.getElementsByTagName("description"));d.error(i.text()),d.error(o.text()),l([{error_code:i.text(),description:o.text()}])})}}}]);