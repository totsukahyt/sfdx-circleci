"use strict";angular.module("SB_NameCard_ImageCtrls",["SB_NameCard_SfdcServices","SB_NameCard_ImageServices"]).controller("TopCtrl",["$scope","sv_config","$log","$svcSettings","$sfdcService","$translate",function(o,t,e,s,n,r){o.android=android,o.iOS=iOSDevice,o.config=t,o.config.useChart=useChart,o.sfdcErr=null,o.working=!0,1==t.enableSfdc?(o.config.sSessionId=configFromEnv.sessionId,o.config.sSfdcEndPoint=configFromEnv.sfdcEndPoint,o.config.sOrgId=configFromEnv.orgId,o.config.sUserName=configFromEnv.userName,o.config.sUserId=configFromEnv.userId,o.config.sClinetIPAddress=configFromEnv.clientIPAddress):(o.config.sSessionId="",o.config.sSfdcEndPoint="",o.config.sOrgId="",o.config.sUserName="",o.config.sUserId="",o.config.sClinetIPAddress="",o.config.sScannerName="SmartViscaS1",o.config.sSmartViscaServer="https://smartvisca.sf.sunbridge.com:8443",o.config.sSfdcEndPoint="https://c.ap0.visual.force.com/services/Soap/u/33.0/00D10000000aqoS",o.config.sOrgId="00D10000000aqoSEAQ",o.config.sUserName="svdev06@sb.co.jp",o.config.sUserId="005100000037rAZAAY",o.config.devMode=!0,o.config.sSessionId="00D10000000aqoS!ARYAQGB0s8xcikcfAyTOzaaF_MNhwP.KG6Qxdpc3OFm.telwpmripS3m1HhZgu0ZCVfjpHKpRMGxZW4L6sM4YsCzCHcM1Mn1"),o.settings=s.get(),o.$watch("settings.svcDoubleSide",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcViewMode",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcRepeatExchangeDate",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcRepeatMemo",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcKeepListName",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcFreehandMemo",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcFrontOnly",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcImageSize",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcImageTransform",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcConfirmTransform",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcShadeFilter",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcNoiseFilter",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcGabageFilter",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcInputImageSize",function(t,e,n){t!==e&&s.set(o.settings)}),o.$watch("settings.svcGeoLocation",function(t,e,n){t!==e&&s.set(o.settings)});var a=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};1==o.config.enableRemoteApi?(n.getSVConfig(function(t){s.set(t),o.settings=s.get(),a(o.config,t),"ja"!==o.config.user.language&&r.use(o.config.user.language),e.info(o.config),o.working=!1,o.$apply()},function(t){e.error(t),o.sfdcErr=t,o.working=!1,o.$apply(),alert($filter("translate")("M_SfdcError"))}),o.config.minLongSidePixcel=600,o.config.maxLongSidePixcel=3e3):(o.working=!1,o.config.sSmartViscaServeServiceID="SFDCAPEX",o.config.sSmartViscaServerOptions=[],o.config.minLongSidePixcel=600,o.config.maxLongSidePixcel=3e3,e.info(o.config))}]).controller("MenuCtrl",["$scope","$log",function(t,e){}]).controller("PhotosCtrl",["$scope","$location","$filter","$q","$log","$state","$svCards","$svModal",function(n,t,e,o,s,r,a,i){n.showDelete=!1,n.imageFile=null,n.cards=a.all(),n.$watch("imageFile",function(t){n.barValue=0,n.Max=0,t&&t.type.match("image.*")&&(i.openLoading(),a.appendFile(t,function(t){s.info(t),i.closeLoading(),n.settings.svcImageTransform&&n.settings.svcConfirmTransform&&r.go("menu.confirm",{cardId:t.index,back:null!=t.back?"t":"f"})},function(t){s.error(t),i.closeLoading()}))}),n.showDeleteBtn=function(t){n.showDelete=t},n.deleteCard=function(t,e){t<0||t>=n.cards.length||(a.remove(n.cards[t],0),n.showDelete=!1,e.stopPropagation())},n.opneDetail=function(t,e){n.showDelete||r.go("menu.detail",{cardId:t})}}]).controller("ConfirmCtrl",["$scope","$log","$state","$stateParams","$window","$svCards","$svModal",function(t,e,n,o,s,r,a){t.card=r.get(o.cardId),t.back="t"==o.back,t.faltTran=t.back?!t.card.back.useTran:!t.card.front.useTran,t.faltTran&&(t.tranError=JSON.stringify(t.back?t.card.back.error:t.card.front.error),t.tranErrorStack=t.back?t.card.back.error.stack:t.card.front.error.stack),t.frameHeight=Math.min(s.innerHeight-200,t.back?t.card.back.height:t.card.front.height),t.remove=function(){r.remove(t.card,t.back?2:0),n.go("menu.photos")},t.toggleTran=function(){t.back?t.card.back.useTran=!t.card.back.useTran:t.card.front.useTran=!t.card.front.useTran,!t.back&&null!=t.card.front.data||t.back&&null!=t.card.back.data||(a.openLoading(),r.createNormal(t.card,t.back,function(){a.closeLoading()},function(t){e.error(t),a.closeLoading()}))},t.confirm=function(){t.back?(t.card.back.useTran&&(t.card.back.blob=t.card.back.tBlob,t.card.back.data=t.card.back.tData),t.card.back.tBlob=null,t.card.back.tData=null,t.card.back.file=null):(t.card.front.useTran&&(t.card.front.blob=t.card.front.tBlob,t.card.front.data=t.card.front.tData),t.card.front.tBlob=null,t.card.front.tData=null,t.card.front.file=null),n.go("menu.photos")}}]).controller("DetailCtrl",["$scope","$log","$location","$stateParams","$timeout","$svCards","$svModal","$filter",function(e,t,n,o,s,r,a,i){var c=o.cardId;t.info(c),e.card=r.get(o.cardId),e.pinchTest=function(t){alert(t.type)},e.reverse=function(){if(e.card.back){var t=e.card.front;e.card.front=e.card.back,e.card.back=t}},e.onSwipeRight=function(){0<c&&n.path("/menu/photos/"+(c-1).toString())},e.onSwipeLeft=function(){c<r.size()-1&&n.path("/menu/photos/"+(c+1).toString())},e.openImage=function(t){e.front=t,a.openImage(e)},e.back=function(){r.updateCard(e.card),n.path("/menu/photos")},e.changeSide=function(t){e.card.back&&(e.modalFront=!e.modalFront)},e.delete={},e.deleteCardSelectSide=function(){e.delete.side=2,a.openConfirm(e,"confirmDeleteSide.html").then(function(){-1===r.remove(e.card,e.delete.side)&&n.path("/menu/photos")},function(){})},e.deleteCard=function(){e.delete.msg="",e.card.back?e.delete.msg=i("translate")("T_DeleteImageDoubleSide"):e.delete.msg=i("translate")("T_DeleteImage"),a.openConfirm(e,"confirmDelete.html").then(function(){r.remove(e.card,0),n.path("/menu/photos")},function(){})}}]).controller("UploadCtrl",["$scope","$log","$location","$timeout","$q","$filter","$svcSettings","$svCards","$svModal","$svServer","$svGps","$svHistory","$sfdcService",function(a,i,e,t,c,o,l,n,s,u,r,d,f){a.working=!0,a.cards=n.all(),a.showLog=!1,a.listName="",1==a.settings.svcKeepListName&&(a.listName=a.settings.svcPreviousListName),a.selectedUser={dept:null,user:{id:null}},a.listNames=[],a.imageCount=0,a.cards.forEach(function(t){a.imageCount+=1,a.imageCount+=t.back?1:0});a.selectOwner=function(){s.openSelectOwner(a,"selectOwner.html").then(function(){i.info(a)},function(){i.info(a)})},a.back=function(){e.path("/menu/photos")};a.status={};function g(){a.showOption=!1,a.status={title:o("translate")("T_Uploading"),msg:"",errMsg:"",finished:!1,success:!1,logs:[],max:0,value:0}}function m(t){i.info(a.config);var s={regoSessionId:"",send_id:"",card_count:0,ownerId:a.selectedUser.user.id,list_name:angular.isObject(a.listName)?a.listName.label:a.listName,freehandmemo_flag:a.settings.svcFreehandMemo?1:0,svcFrontOnly:a.settings.svcFrontOnly,result_count:0,finish_code:-1,error_code:"",description:""};s.card_count=a.cards.length,$("sendScanLotData Start "+s.card_count+"-"+a.imageCount),a.settings.svcPreviousListName=s.list_name,l.set(a.settings);for(var e=function(n){var o=c.defer();return u.sendScanLotData(n,a.config,function(t){n.regoSessionId=t.regoSessionId,n.send_id=t.send_id,$("sendScanLotData: OK"),o.resolve()},function(t){var e=S(t);i.error(e),n.error_code=t?t[0].error_code:"",n.description=t?t[0].description:"",$("sendScanLotData NG",e),o.reject(e)}),o.promise}(s),r=-1,n=0;n<s.card_count;n++)e=(e=e.then(function(){a.status.value++,r++;var n,e,o,t=a.cards[r];return $("sendCardData Start "+(r+1)),n=s,e=t,o=c.defer(),u.sendCardData(n,e,a.config,function(t){e.card_id=t.card_id,e.result+=1,$("sendCardData: OK"),o.resolve()},function(t){var e=S(t);i.error(e),n.error_code=t?t[0].error_code:"",n.description=t?t[0].description:"",$("sendCardData NG",e),o.reject(e)}),o.promise},function(t){return t.forEach(function(t){a.status.errMsg+=t.text}),a.status.msg=o("translate")("M_SendFalt")+"(1)",a.status.success=!1,a.status.finished=!0,a.working=!1,null})).then(function(){if(a.status.finished)return null;a.status.value++;var n,e,o,t=a.cards[r];return $("sendBackCardData Start"),n=s,e=t,o=c.defer(),u.sendBackCardData(n,e,a.config,function(t){e.card_id=t.card_id,e.result+=2,$("sendBackCardData: OK"),o.resolve()},function(t){i.error(t),n.error_code=t?t[0].error_code:"",n.description=t?t[0].description:"",console.log(t);var e=S(t);$("sendBackCardData NG",e),o.reject(e)}),o.promise},function(t){return t.forEach(function(t){a.status.errMsg+=t.text}),a.status.msg=o("translate")("M_SendFalt")+"(2)",a.status.success=!1,a.status.finished=!0,a.working=!1,null});e.then(function(){return a.status.finished?null:(a.status.value++,$("sendEnd Start"),function(n){var o=c.defer();return u.sendEnd(n,a.config,function(t){n.result_count=t.send_count,n.finish_code=t.finish_code,$("sendEnd: OK"),o.resolve()},function(t){i.error(t),n.error_code=t?t[0].error_code:"",n.description=t?t[0].description:"";var e=S(t);$("sendEnd NG",e),o.reject(e)}),o.promise}(s))},function(t){return t.forEach(function(t){a.status.errMsg+=t.text}),a.status.msg=o("translate")("M_SendFalt")+"(3)",a.status.success=!1,a.status.finished=!0,a.working=!1,null}).then(function(){if(a.status.finished)return null;a.status.value++,"0"===s.finish_code?k(t):(a.status.errMsg=s.error_code+": "+s.description,a.status.msg=o("translate")("M_SendFalt")+"(4)",a.status.success=!1,a.status.finished=!0,a.working=!1)},function(t){return t.forEach(function(t){a.status.errMsg+=t.text}),a.status.msg=o("translate")("M_SendFalt")+"(5)",a.status.success=!1,a.status.finished=!0,a.working=!1,null})}function h(){0!=a.cards.length&&(a.selectedUser.user&&a.selectedUser.user.id||(a.selectedUser={dept:null,user:{label:a.config.myName,id:a.config.userId}}),s.openConfirm(a,"confirmSend.html").then(function(){g(),a.status.msg=o("translate")("T_Sending"),a.status.value=0,a.status.max=2*a.cards.length+2+(a.settings.svcGeoLocation?1:0),a.status.msg=o("translate")("T_Sending"),s.openProgress(a).then(function(t){a.status.success&&e.path("/menu/land")});var t=d.getTemplate(a);(function(e){var n=c.defer();return a.settings.svcGeoLocation?($("getCurrentLocation Start"),r.getCurrentLocation(function(t){a.status.value++,$("getCurrentLocation OK"),e.location.lat=t.lat,e.location.lng=t.lng,a.$apply(),n.resolve()},function(t){var e=S(t);$("getCurrentLocation NG",e),a.status.logs.push((new Date).toLocaleString()+": "+o("translate")("M_DisableGps")),a.status.msg=o("translate")("M_SetupGps"),a.status.errMsg=e,a.status.finished=!0,a.status.success=!1,a.$apply(),n.reject()})):n.resolve(),n.promise})(t).then(function(){m(t)},function(){i.error("getCurrentLocation failed.")})},function(){a.showLog=!1,g()}))}var p,v,$=function(e,t){if(a.showLog){var n=new Date;angular.isUndefined(t)?a.status.logs.push(n.toLocaleString()+": "+e):t.forEach(function(t){a.status.logs.push(n.toLocaleString()+": "+e+" "+t.text)})}},S=function(t){if(angular.isUndefined(t))return[{error_code:"-1",description:o("translate")("T_NetError")}];var n=[];return t.forEach(function(t){var e={};e.text=t.error_code+": "+t.description,n.push(e)}),n},k=function(t){d.append(t),$("Logging OK"),n.clear(),a.status.msg=o("translate")("M_SendSuccess"),a.status.success=!0,a.status.finished=!0,a.working=!1};a.buttonOnLongPress=function(){a.showOption=!0,a.showLog=!0},a.buttonOnTouchEnd=function(){h()},1==a.config.enableRemoteApi?(p=2,v=null,f.getTagsOrListnames(p,v,function(t){a.listNames=t,a.working=!1,a.$apply()},function(t){console.log(t),a.err=t,a.working=!1,a.$apply()})):a.working=!1}]).controller("SettingsCtrl",["$scope","$log","$timeout",function(t,e,n){t.options={floor:t.config.minLongSidePixcel,ceil:t.config.maxLongSidePixcel,step:10},n(function(){$(".rz-pointer").mousedown(),$(".rz-pointer").mouseup()},100)}]).controller("HistoryCtrl",["$scope","$timeout","$svHistory","$svModal",function(t,e,n,o){t.logs=n.getDailyBlocked(),t.refresh=function(){t.logs=n.getDailyBlocked()},t.deleteHistory=function(){o.openConfirm(t,"confirmDeleteHistory.html").then(function(){n.clear(),t.logs=[]},function(){})}}]).controller("AboutCtrl",["$scope",function(t){console.log(t.config)}]).controller("TestCtrl",["$scope","Chats","$timeout","$filter","$svGps","$svServer",function(e,n,t,o,s,r){e.chats=n.all(),e.deleteItem=function(t){n.remove(t)},e.startPromise=function(){s.getCurrentLocationPromise().then(function(t){console.log(t)})};function a(t){console.log(t)}e.start=function(){s.getCurrentLocation(a,a)},e.loginUserAuth=function(){e.working=!0,r.loginUserAuth(e.config,function(t){e.$apply()},function(t){console.log(t),e.err=t,e.$apply()}),e.working=!1},e.userAuth=function(){e.working=!0,r.userAuth(e.config,function(t){e.$apply()},function(t){console.log(t),e.err=t,e.$apply()}),e.working=!1}}]).controller("ChartCtrl",["$scope","$log","$q","$window","$sfdcService",function(t,e,n,o,s){t.data=[],t.width=o.innerWidth-20;t.chart={type:"PieChart",data:[["現況","数"]],options:{displayExactValues:!0,width:t.width,height:600,is3D:!0,title:"現況",chartArea:{left:10,top:10,bottom:0,height:"100%"}}}}]);