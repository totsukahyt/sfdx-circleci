/**
 *
 * SB_NameCardL_HojinkakuParser
 *  æ³•äººæ ¼ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã‚¯ãƒ©ã‚¹
 *  
 **/
public with sharing class SB_NameCardL_HojinkakuParser {

    //  ç•¥ã®ã‚ã‚‹æ³•äººæ ¼ System.Label.SB_NCL_HojinKakuPairs
    // 1ã¤ã®æ­£å¼åç§°ãŒ1ã¤ä»¥ä¸Šã®ç•¥ç§°ã«ãªã‚‹ ã‚‚ã®ã®ã†ã¡ã€è¤‡æ•°ã®æ­£å¼åç§°ãŒ1ã¤ã®ç•¥ç§°ã‚’å…±æœ‰ã™ã‚‹ã‚‚ã®ã‚’é™¤ã
    // æ ªå¼ä¼šç¤¾, æ ª, ãˆ±
    // æœ‰é™ä¼šç¤¾, æœ‰, ãˆ²
    // åˆåä¼šç¤¾, å, ãˆ´
    // åˆè³‡ä¼šç¤¾, è³‡, ãˆ¾
    // åˆåŒä¼šç¤¾, åŒ, åˆåŒ
    // å­¦æ ¡æ³•äºº, å­¦, ãˆ»
    // ç¤¾å›£æ³•äºº, ç¤¾, ãˆ³
    // ç‰¹æ®Šæ³•äºº, ç‰¹, ãˆµ
    // è²¡å›£æ³•äºº, è²¡, ãˆ¶
    // ç›£æŸ»æ³•äºº, ç›£, ç›£æ³•, ãˆ¼
    // ä¼æ¥­çµ„åˆ, ä¼, ãˆ½
    // å”åŒçµ„åˆ, å”, ãˆ¿
    // åŠ´åƒçµ„åˆ, åŠ´, ãˆ¸
    // ä¸€èˆ¬ç¤¾å›£æ³•äºº, ä¸€ç¤¾
    // ä¸€èˆ¬è²¡å›£æ³•äºº, ä¸€è²¡
    // å…¬ç›Šç¤¾å›£æ³•äºº, å…¬ç¤¾
    // å…¬ç›Šè²¡å›£æ³•äºº, å…¬è²¡
    // ç‹¬ç«‹è¡Œæ”¿æ³•äºº, ç‹¬
    // åœ°æ–¹ç‹¬ç«‹è¡Œæ”¿æ³•äºº, åœ°ç‹¬
    // ç‰¹å®šéå–¶åˆ©æ´»å‹•æ³•äºº, ç‰¹é, ç‰¹å®š
    // å®—æ•™æ³•äºº, å®—
    // ç›¸äº’ä¼šç¤¾, ç›¸
    // ç¤¾ä¼šç¦ç¥‰æ³•äºº, ç¦
    // å¼è­·å£«æ³•äºº, å¼, å¼æ³•
    // è¡Œæ”¿æ›¸å£«æ³•äºº, è¡Œ
    // å¸æ³•æ›¸å£«æ³•äºº, å¸
    // ç¨ç†å£«æ³•äºº, ç¨, ç¨æ³•
    
    //System.Label.SB_NCL_HojinkakuDuplicate
    // è¤‡æ•°ã®æ­£å¼åç§°ãŒ1ã¤ã®ç•¥ç§°ã‚’å…±æœ‰ã™ã‚‹ã‚‚ã®
    // åŒ»ç™‚æ³•äºº, åŒ»ç™‚æ³•äººç¤¾å›£, åŒ»ç™‚æ³•äººè²¡å›£, ç¤¾ä¼šåŒ»ç™‚æ³•äºº  ã®ãã‚Œãã‚Œã‚’ (åŒ»)ã¨åŒä¸€è¦–
    // è¤‡æ•°ã®æ­£å¼åç§°ãŒï¼‘ã¤ã®ç•¥ç§°ã«ãªã‚‹ã‚‚ã®
    // private static final String DUPLICTE_RYAKUSHO = 'åŒ»:åŒ»ç™‚æ³•äºº, åŒ»ç™‚æ³•äººç¤¾å›£, åŒ»ç™‚æ³•äººè²¡å›£, ç¤¾ä¼šåŒ»ç™‚æ³•äºº
    // å¤§:å›½ç«‹å¤§å­¦æ³•äºº, å…¬ç«‹å¤§å­¦æ³•äºº
    // å›½æ³•:å›½ç«‹å¤§å­¦æ³•äºº
    // ä¸­:æœ‰é™è²¬ä»»ä¸­é–“æ³•äºº, ç„¡é™è²¬ä»»ä¸­é–“æ³•äºº';
    
      @TestVisible
      private static Map<String, Integer> hojinkaku2id {  // æ³•äººæ ¼æ–‡å­—åˆ— - è­˜åˆ¥å­
        get {
          if (hojinkaku2id == null) {
            // æ³•äººæ ¼æ–‡å­—åˆ— - è­˜åˆ¥å­
            hojinkaku2id = new Map<String, Integer>();
            String[] lines = System.Label.SB_NCL_HojinKakuPairs.split('\\r\\n|\\n|\\r');
            for (Integer n=0; n < lines.size(); n++) {
              String[] mojis = lines.get(n).split(',\\s*');
              for (String moji : mojis) {
                hojinkaku2id.put(moji, n);   // æ³•äººæ ¼æ–‡å­—åˆ— - è­˜åˆ¥å­
                System.debug(LoggingLevel.DEBUG, moji + n);
              }
            }
          }
          return hojinkaku2id;
        }
        private set;
      }
    
      public static Integer getHojinkakuId(String kaku) {
        if (String.isBlank(kaku)) {
          return -1;
        }
        if (!hojinkaku2id.containsKey(kaku)) {
          return -1;
        }
        return hojinkaku2id.get(kaku);
      }
    
      // private static final String HOJIN_REGEX0 =
      // (?:æ ªå¼ä¼šç¤¾|æœ‰é™ä¼šç¤¾|åˆåä¼šç¤¾|åˆè³‡ä¼šç¤¾|åˆåŒä¼šç¤¾|å­¦æ ¡æ³•äºº|ç‰¹æ®Šæ³•äºº|ç›£æŸ»æ³•äºº|ä¼æ¥­çµ„åˆ|å”åŒçµ„åˆ|åŠ´åƒçµ„åˆ|åŒ»ç™‚æ³•äººç¤¾å›£|åŒ»ç™‚æ³•äººè²¡å›£|ç¤¾ä¼šåŒ»ç™‚æ³•äºº|ç‰¹å®šåŒ»ç™‚æ³•äºº|åŒ»ç™‚æ³•äºº|ä¸€èˆ¬ç¤¾å›£æ³•äºº|å…¬ç›Šç¤¾å›£æ³•äºº|ç¤¾å›£æ³•äºº|ä¸€èˆ¬è²¡å›£æ³•äºº|å…¬ç›Šè²¡å›£æ³•äºº|è²¡å›£æ³•äºº|ç¤¾ä¼šç¦ç¥‰æ³•äºº|æ›´ç”Ÿä¿è­·æ³•äºº|ç‹¬ç«‹è¡Œæ”¿æ³•äºº|åœ°æ–¹ç‹¬ç«‹è¡Œæ”¿æ³•äºº|ç‰¹å®šéå–¶åˆ©æ´»å‹•æ³•äºº|å®—æ•™æ³•äºº|ç›¸äº’ä¼šç¤¾|ç¤¾ä¼šç¦ç¥‰æ³•äºº|å¼è­·å£«æ³•äºº|è¡Œæ”¿æ›¸å£«æ³•äºº|å¸æ³•æ›¸å£«æ³•äºº|ç¨ç†å£«æ³•äºº|å›½ç«‹å¤§å­¦æ³•äºº|å…¬ç«‹å¤§å­¦æ³•äºº|æœ‰é™è²¬ä»»ä¸­é–“æ³•äºº|ç„¡é™è²¬ä»»ä¸­é–“æ³•äºº|(?:[(ï¼ˆ](?:[æ ªæœ‰åè³‡åŒå­¦ç¤¾ç‰¹è²¡ç›£ä¼å”åŠ´åŒ»ç‹¬å®—ç›¸ç¦å¼è¡Œå¸ç¨å¤§ä¸­]|ä¸€ç¤¾|ä¸€è²¡|å…¬ç¤¾|å…¬è²¡|åœ°ç‹¬|ç‰¹é|å¼æ³•|ç¨æ³•|å›½æ³•)[ï¼‰)])|[ãˆ±ãˆ²ãˆ´ãˆ¾ãˆ»ãˆ³ãˆµãˆ¶ãˆ¼ãˆ½ãˆ¿ãˆ¸]);
      // private static final String HOJIN_REGEX = '(^' + HOJIN_REGEX0 + '[\\sã€€]*)(.+$)' + '|' + '(^.+)(' + HOJIN_REGEX0 + '$)';
      // SB_NC_HojinKakuRegexFormat â†’ (^{0}[\\\sã€€]*)(.+$)|(^.+?)({0}$)  ã‚«ã‚¹ã‚¿ãƒ è¡¨ç¤ºãƒ©ãƒ™ãƒ«ã«ã—ã¦ \\s ã ã¨ s ã‚’æ‹¾ã£ã¦ã—ã¾ã†ã®ã§ \\\s ã«ã—ã¦ã¾ã™ã€‚  å¾Œæ ¼ã®ã¨ãã€ä½™è¨ˆã«ã¨ã‚‰ãªã„ã‚ˆã†ã«(^.+?) ã§ ? ã¤ã
    
      private static Pattern hojinPattern  {
        get {
          if (hojinPattern == null) {
            hojinPattern = Pattern.compile(String.format(System.Label.SB_NCL_HojinKakuRegexFormat, new String[] { System.Label.SB_NCL_HojinKakuRegex }));
          }
          return hojinPattern;
        }
        private set;
      }
    
      // ä¼šç¤¾åã‚’æ³•äººæ ¼ã¨ç¤¾åã«ãƒ‘ãƒ¼ã‚¹
      //   ç¢ºèªç”¨ã« public ã§
      //  4ã¤ã®è¦ç´ ã®ãƒªã‚¹ãƒˆã§ã‹ãˆã™ã€‚
      // å‰æ ¼ã®å ´åˆã€æ³•äººæ ¼(ç©ºç™½),ç¤¾å,null,null
      // å¾Œæ ¼ã®å ´åˆã€null,null,ç¤¾å(ç©ºç™½),æ³•äººæ ¼
      public static List<String> regexKaishamei(String kaishamei) {
        List<String> result;
        Matcher m = hojinPattern.matcher(kaishamei.trim());
        if (m.find()) { 
          result = new List<String>();
          for (Integer j = 1; j <= m.groupCount(); j++) {
            if (String.isNotBlank(m.group(j))) {
              result.add(m.group(j).trim().replaceAll('[\\sã€€]*$', '')); // å‰æ ¼ã®å¾Œã®åŠè§’ç©ºç™½ã€å…¨è§’ç©ºç™½ã€å¾Œæ ¼ã®å ´åˆã®ç¤¾åã®ã‚ã¨ã®åŠè§’ç©ºç™½ã€å…¨è§’ç©ºç™½ã¯ï¼‘ã¤ã«ãªã£ã¦ã‚‹ã®ã§é™¤å»ã€å¿µã®ç‚ºtrim
            }
            else {
              result.add(m.group(j));
            }
          }
        }
        return result;
      }
    
      private String fullname;
      private String kaku;
      private String shamei;
      private Integer kakuIchi; // -1: æ ¼ãªã—ã€0:å‰æ ¼ 1:å¾Œæ ¼
      private Integer kakuId;  // æ³•äººæ ¼ã®è­˜åˆ¥å­ ç•¥ãŒãªã„ã‹ã€æ ¼ãƒŠã‚·ã¯ -1
      public SB_NameCardL_HojinkakuParser(String kaishamei) {
        this.fullname = kaishamei;
        this.kakuId = -1;
        List<String> texts = regexKaishamei(kaishamei);
        if (texts == null || texts.size() != 4) {
          // æ ¼ãªã—
          this.kakuId = -1;
          this.shamei = kaishamei;
        } 
        else {
          this.kakuIchi = texts[0]!=null ? 0 : 1;
          if (this.kakuIchi == 0) { // å‰æ ¼
            // this.kaku = texts[0].replaceAll('^[(ï¼ˆ]', '').replaceAll('[)ï¼‰]$', '')  // å‰å¾Œã®ä¸¸æ‹¬å¼§1æ–‡å­—ã¯é™¤å»
            this.kaku = texts[0].replaceAll('[()ï¼ˆï¼‰]', ''); // æ ¼ã«ã¤ã„ã¦ã‚‹ä¸¸æ‹¬å¼§ã¯ã¨ã£ã¦ãŠã å–ã‚Šå‡ºã—ãŸæ³•äººæ ¼ã§ã¯ã‚ã£ã¦ã‚‚å‰å¾Œã«1æ–‡å­—ã¥ã¤ getHojinkakuId ã®ä¸­ã¯ ï¼ˆï¼‰ã€€ãªã—ã§ã¿ã‚‹
            this.shamei = texts[1]; // ç¤¾å
          }
          else {  // å¾Œæ ¼
            this.shamei = texts[2]; // ç¤¾å
            this.kaku = texts[3].replaceAll('[()ï¼ˆï¼‰]', '');
          }
          this.kakuId = getHojinkakuId(this.kaku);
        } 
      }
    
      public Boolean isEqual(String kaishamei) {
        return this.fullname == kaishamei || isEqual(new SB_NameCardL_HojinkakuParser(kaishamei));
      }
    
      public Boolean isEqual(SB_NameCardL_HojinkakuParser sha) {
        System.debug(this.kakuIchi == sha.kakuIchi);
        System.debug(this.kakuId == sha.kakuId);
        System.debug(this.shamei == sha.shamei);
        System.debug(this.kakuId != -1);
        return this.kakuIchi == sha.kakuIchi && this.kakuId == sha.kakuId && this.shamei == sha.shamei &&
          (this.kakuId != -1 || this.kaku == sha.kaku || isEqualDuplicateRyakusho(sha.kaku));  // ã©ã‚Œã§ã‚‚ãªã‹ã£ãŸã‚‰ã€æœ€å¾Œã€åŒ»ç™‚æ³•äººç­‰ã®ç•¥ç§°å…±æœ‰å‹ã«ã¤ã„ã¦èª¿ã¹ã‚‹
      }
     
      // è¤‡æ•°ã®æ­£å¼åç§°ãŒ1ã¤ã®ç•¥ç§°ã‚’å…±æœ‰ã™ã‚‹ã‚‚ã®   ãã®ã‚¿ã‚¤ãƒ—ã®æ­£å¼åç§°ã¯ 1ã¤ã®æ­£å¼åç§°ãŒ1ã¤ä»¥ä¸Šã®ç•¥ç§°ã«ãªã‚‹ ã“ã¨ã‚‚ã“ã¡ã‚‰ã§å¯¾å¿œï¼ˆä¾‹ï¼šå›½ç«‹å¤§å­¦æ³•äººï¼‰
      // SB_NC_HojinkakuDuplicate
      // å¤§:å›½ç«‹å¤§å­¦æ³•äºº, å…¬ç«‹å¤§å­¦æ³•äºº
      // å›½æ³•:å›½ç«‹å¤§å­¦æ³•äºº
      // ä¸­:æœ‰é™è²¬ä»»ä¸­é–“æ³•äºº, ç„¡é™è²¬ä»»ä¸­é–“æ³•äºº  
      // åŒ»:åŒ»ç™‚æ³•äºº, åŒ»ç™‚æ³•äººç¤¾å›£, åŒ»ç™‚æ³•äººè²¡å›£, ç¤¾ä¼šåŒ»ç™‚æ³•äºº
      // ç‰¹å®šåŒ»ç™‚æ³•äºº ã®ç•¥ã¯ (åŒ») ã§ãªã„ã€‚ã‚‰ã—ã„ã€‚
      private static Map<String, Set<String>> ryaku2longs {  // ç•¥ç§° - æ­£å¼åç§°s
        get {
          if (ryaku2longs == null) {
            ryaku2longs = new Map<String, Set<String>>();
            // String[] lines = DUPLICTE_RYAKUSHO.split('\\r\\n|\\n|\\r');
            String[] lines = System.Label.SB_NCL_HojinkakuDuplicate.split('\\r\\n|\\n|\\r');
            for (String line : lines) {
              String[] pair = line.trim().split(':\\s*');
              if (pair.size() == 2) { // ä¸€å¿œã€èª¿ã¹ã‚‹ã€‚
                Set<String> longs = new Set<String>();
                String[] ll = pair[1].trim().split(',\\s*');
                for (String l : ll) {
                  longs.add(l);
                }
                ryaku2longs.put(pair[0].trim(), longs);
              }
            }
          }
          return ryaku2longs;
        }
        private set;
      }
      
      // è¤‡æ•°ã®æ­£å¼åç§°ãŒï¼‘ã¤ã®ç•¥ç§°ã«ãªã‚‹ã‚¿ã‚¤ãƒ—ã®ã‚’èª¿ã¹ã‚‹
      private Boolean isEqualDuplicateRyakusho(String kaku) {
        if (ryaku2longs.containsKey(this.kaku)) {
          // ã“ã£ã¡ã®ãŒç•¥ç§°ã§ã‚ã£ãŸ
          return ryaku2longs.get(this.kaku).contains(kaku);
        }
        else if (ryaku2longs.containsKey(kaku)) {
          // ãã£ã¡ã®ãŒç•¥ç§°ã§ã‚ã£ãŸ
          return ryaku2longs.get(kaku).contains(this.kaku);
        }
        // ãã®ç•¥ç§°ã¯ãªã‹ã£ãŸ
        return false;
      }
    
    
      public static Boolean isEqualeKaishamei(String a, String b) {
        if (a==b) {
          return true;
        }
        SB_NameCardL_HojinkakuParser k_a = new SB_NameCardL_HojinkakuParser(a);
        SB_NameCardL_HojinkakuParser k_b = new SB_NameCardL_HojinkakuParser(b);
        return k_a.isEqual(k_b);
      }
    
    }